--source include/have_debug.inc

# PS-7140: crypt redo logs are not applied correctly

--let $MYSQLD_DATADIR=`select @@datadir`
--let t1_IBD = $MYSQLD_DATADIR/test/t1.ibd
--let t2_IBD = $MYSQLD_DATADIR/test/t2.ibd
--let t3_IBD = $MYSQLD_DATADIR/test/t3.ibd

--echo # Make sure that changes to disk will not get
--echo # applied and stay only in redo.
set global innodb_page_cleaner_disabled_debug=on;
create table t1(a varchar(255)) encryption='N';
insert t1 values (repeat('foobarsecret', 12));
create table t2(a varchar(255)) encryption='KEYRING';
insert t2 values (repeat('tempsecret', 12));

--source include/kill_and_restart_mysqld.inc

--let $assert_text= Make sure t1 is included in INFORMATION_SCHEMA tablespace with MIN_KEY_VERSION equal to 0
--let $assert_cond= "[SELECT MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE name=\\'test/t1\\']" = 0
--source include/assert.inc

--let $assert_text= Make sure t2 is included in INFORMATION_SCHEMA tablespace with MIN_KEY_VERSION equal to 1
--let $assert_cond= "[SELECT MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE name=\\'test/t2\\']" = 1
--source include/assert.inc

--let SEARCH_PATTERN=PSB
--let ABORT_ON=NOT_FOUND
--let SEARCH_FILE=$t1_IBD
--source include/search_pattern_in_file.inc
--let SEARCH_FILE=$t2_IBD
--source include/search_pattern_in_file.inc

--let SEARCH_PATTERN=foobarsecret
--let ABORT_ON=NOT_FOUND
--let SEARCH_FILE=$t1_IBD
--source include/search_pattern_in_file.inc
--let SEARCH_PATTERN=tempsecret
--let ABORT_ON=FOUND
--let SEARCH_FILE=$t2_IBD
--source include/search_pattern_in_file.inc


--echo #cleanup
DROP TABLE t1,t2;
