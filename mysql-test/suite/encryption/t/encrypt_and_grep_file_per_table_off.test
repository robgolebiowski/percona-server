-- source include/have_innodb.inc
#-- source include/have_file_key_management_plugin.inc

# embedded does not support restart
-- source include/not_embedded.inc

#--echo $KEYRING_PLUGIN_OPT
#--echo $KEYRING_PLUGIN_LOAD

--replace_result $MYSQL_TMP_DIR MYSQL_TMP_DIR
eval SET @@global.keyring_file_data="$MYSQL_TMP_DIR/mysecret_keyring";

SHOW PLUGINS;
#
# MDEV-8138: strange results from encrypt-and-grep test
#
--let $MYSQLD_DATADIR=`select @@datadir`
--let ib1_IBD = $MYSQLD_DATADIR/ibdata1

--disable_warnings
SET GLOBAL innodb_file_format = `Barracuda`;
--enable_warnings

# It is not possible to create table with explicit encryption when file-per-table is OFF
--error ER_ILLEGAL_HA_CREATE_OPTION
CREATE TABLE t0 (a varchar(255)) engine=innodb encryption='ROTATED_KEYS';

--error ER_INVALID_ENCRYPTION_OPTION
CREATE TABLESPACE ts_rk_encrypted_impossible ADD DATAFILE 'ts_rk_encrypted_impossible.ibd' ENCRYPTION='ROTATED_KEYS';

--error ER_ILLEGAL_HA_CREATE_OPTION
CREATE TABLE p2 (a TEXT) TABLESPACE=innodb_system ENCRYPTION="ROTATED_KEYS" ENGINE="InnoDB";

# Temporarily turning on innodb_file_per_table
# As it should not be possible to create table as a part of tablespace
SET GLOBAL innodb_file_per_table=ON;
--error ER_ILLEGAL_HA_CREATE_OPTION
CREATE TABLE p2 (a TEXT) TABLESPACE=innodb_system ENCRYPTION="ROTATED_KEYS" ENGINE="InnoDB";
SET GLOBAL innodb_file_per_table=OFF;

create table t1 (a varchar(255)) engine=innodb;
create table t2 (a varchar(255)) engine=innodb;
show warnings;
create table t3 (a varchar(255)) engine=innodb;


insert t1 values (repeat('foobarsecret', 12));
insert t2 values (repeat('foobarsecret', 12));
insert t3 values (repeat('foobarsecret', 12));

--let tablespaces_count=`select count(*) from INFORMATION_SCHEMA.INNODB_SYS_TABLESPACES`

--echo # Wait for system space to get encrypted

--let $wait_timeout= 600
# All tablespaces should get encrypted + artificial tablespace innodb_system
--let $wait_condition=SELECT COUNT(*) = $tablespaces_count + 1 FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 1
--source include/wait_condition.inc

--let $assert_text= All tablespaces should have encrypted flag set
--let $assert_cond= "[SELECT COUNT(*) FROM INFORMATION_SCHEMA.INNODB_SYS_TABLESPACES WHERE FLAG <> 8225]" = 0
--source include/assert.inc

SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLESPACES;
SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLES;
SELECT * FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION;

--source include/shutdown_mysqld.inc

--let SEARCH_PATTERN=foobarsecret
--let ABORT_ON=FOUND
--echo # ibdata1 expecting NOT FOUND
--let SEARCH_FILE=$ib1_IBD
--source include/search_pattern_in_file.inc

--let $restart_parameters=restart:--early-plugin-load="keyring_file=$KEYRING_PLUGIN" --loose-keyring_file_data=$MYSQL_TMP_DIR/mysecret_keyring $KEYRING_PLUGIN_OPT --innodb-encrypt-tables=ON --innodb-encryption-rotate-key-age=15 --innodb-encryption-threads=1
-- source include/start_mysqld.inc

--echo # Now turn off encryption and wait for threads to decrypt everything

SET GLOBAL innodb_encrypt_tables = off;

--let $wait_timeout= 600
--let $wait_condition=SELECT COUNT(*) = 0 FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 1
--source include/wait_condition.inc

--let $assert_text= No table should have encrypted flag set
--let $assert_cond= "[SELECT COUNT(*) FROM INFORMATION_SCHEMA.INNODB_SYS_TABLESPACES WHERE FLAG = 8225]" = 0
--source include/assert.inc

--source include/shutdown_mysqld.inc

--let ABORT_ON=NOT_FOUND
--echo # ibdata1 expecting NOT FOUND
--let SEARCH_FILE=$ib1_IBD
--source include/search_pattern_in_file.inc

--let $restart_parameters=restart:--early-plugin-load="keyring_file=$KEYRING_PLUGIN" --loose-keyring_file_data=$MYSQL_TMP_DIR/mysecret_keyring $KEYRING_PLUGIN_OPT --innodb-encrypt-tables=ON --innodb-encryption-rotate-key-age=15 --innodb-encryption-threads=4

-- source include/start_mysqld.inc

--echo # Wait for system space to get encrypted
--let $wait_timeout= 600
--let $wait_condition=SELECT COUNT(*) = 1 FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 1 AND NAME='innodb_system'
--source include/wait_condition.inc

SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 0;
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;

SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLESPACES;
SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLES;

--source include/shutdown_mysqld.inc

--let SEARCH_PATTERN=foobarsecret
--let ABORT_ON=FOUND
--echo # ibdata1 expecting NOT FOUND
--let SEARCH_FILE=$ib1_IBD
--source include/search_pattern_in_file.inc

--source include/start_mysqld.inc

drop table t1, t2, t3;

