--source include/have_64bit.inc

#
# MDEV-8588: Assertion failure in file ha_innodb.cc line 21140 if at least one encrypted
# table exists and encryption service is not available.
#

#call mtr.add_suppression("Plugin 'file_key_management' init function returned error");
#call mtr.add_suppression("Plugin 'file_key_management' registration.*failed");
call mtr.add_suppression("InnoDB: The page \\[page id: space=[1-9][0-9]*, page number=[1-9][0-9]*\\] in file '.*test.t[12]\\.ibd' cannot be decrypted\\. Are you using correct keyring?");
call mtr.add_suppression("\\[InnoDB\\] The page \\[page id: space=4, page number=[4-5]\\] in file '\./test/t2\.ibd' cannot be decrypted\. Are you using correct keyring?");


#call mtr.add_suppression("failed to read or decrypt \\[page id: space=[1-9][0-9]*, page number=[1-9][0-9]*\\]");
#call mtr.add_suppression("File '.*mysql-test.std_data.keysbad3\\.txt' not found");

#call mtr.add_suppression("\\[Error\\] InnoDB: Page is still encrypted");
#call mtr.add_suppression("\\[Warning\\] InnoDB: Table is encrypted but encryption service or used key_id is not available\.  Can't continue reading table\.");
call mtr.add_suppression("\\[Warning\\] InnoDB: Cannot save statistics for table `test`\.`t2` because file \./test/t2\.ibd cannot be decrypted\.");
#call mtr.add_suppression("\\[Warning\\] InnoDB: Table in tablespace is encrypted but encryption service or used key_id is not available\.  Can't continue reading table\.");
call mtr.add_suppression("\\[InnoDB\\] Tablespace id 3 in file t1.ibd is encrypted but keyring or used key_id 2 is not available. Can't continue reading table. Please provide the correct keyring\.");

--echo # Start server with keys2.txt
--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
--let $restart_parameters=restart:--keyring-file-data=$MYSQLTEST_VARDIR/std_data/keys2.txt
--source include/restart_mysqld.inc

SET GLOBAL innodb_file_per_table = ON;

CREATE TABLE t1 (c VARCHAR(8)) ENGINE=InnoDB ENCRYPTION='KEYRING' ENCRYPTION_KEY_ID=2;
INSERT INTO t1 VALUES ('foobar');
ALTER TABLE t1 ADD COLUMN c2 INT;
INSERT INTO t1 VALUES ('foobar',2);
SELECT * FROM t1;
TRUNCATE TABLE t1;
SELECT * FROM t1;
INSERT INTO t1 VALUES ('foobar',1);
INSERT INTO t1 VALUES ('foobar',2);
FLUSH TABLE WITH READ LOCK;
SELECT * FROM t1;

let $log_error= `SELECT @@GLOBAL.log_error`;
if($log_error == "stderr")
{
  let $log_error = $MYSQLTEST_VARDIR/log/mysqld.1.err;
}

--source include/shutdown_mysqld.inc

--echo # Make sure that there is no error in error log related to missing key for t1

--let SEARCH_PATTERN=Tablespace id 3 in file t1.ibd is encrypted but keyring or used key_id 2 is not available. Can't continue reading table. Please provide the correct keyring
--let ABORT_ON=FOUND
--let SEARCH_FILE=$log_error
--source include/search_pattern_in_file.inc

--echo
--echo # Restart server with keysbad3.txt
--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
--let $restart_parameters=restart:--keyring-file-data=$MYSQLTEST_VARDIR/std_data/keysbad3.txt
--source include/start_mysqld.inc
#--source include/restart_mysqld.inc

--error ER_GET_ERRMSG
SELECT * FROM t1;

--replace_regex /tablespace [0-9]*/tablespace /
DROP TABLE t1;

--source include/shutdown_mysqld.inc

--let SEARCH_PATTERN=Tablespace id 3 in file t1.ibd is encrypted but keyring or used key_id 2 is not available. Can't continue reading table. Please provide the correct keyring
--let ABORT_ON=NOT_FOUND
--let SEARCH_FILE=$log_error
--source include/search_pattern_in_file.inc

#
# MDEV-8591: Database page corruption on disk or a failed space, Assertion failure in file buf0buf.cc
# line 2856 on querying a table using wrong default encryption key
#

--echo # Start server with keys3.txt
--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
-- let $restart_parameters=restart:--keyring-file-data=$MYSQLTEST_VARDIR/std_data/keys3.txt
-- source include/start_mysqld.inc

SET GLOBAL innodb_stats_persistent=OFF;

# encryption_key_id 5 exists in keys3.txt and in keys2.txt. The id is the same, but the keys themselves
# are different.
SET SESSION innodb_default_encryption_key_id=5;
CREATE TABLE t2 (c VARCHAR(8), id int not null primary key, b int, key(b)) ENGINE=InnoDB ENCRYPTION='KEYRING';

INSERT INTO t2 VALUES ('foobar',1,2);

--echo
--echo # Restart server with keys2.txt
--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
-- let $restart_parameters=restart:--keyring-file-data=$MYSQLTEST_VARDIR/std_data/keys2.txt
-- source include/restart_mysqld.inc

SET GLOBAL innodb_stats_persistent=ON;

--disable_warnings
--error ER_GET_ERRMSG
SELECT * FROM t2;

--error ER_GET_ERRMSG
SELECT * FROM t2 where id = 1;

--error ER_GET_ERRMSG
SELECT * FROM t2 where b = 1;

--replace_regex /tablespace [0-9]*/tablespace /
--error ER_GET_ERRMSG
INSERT INTO t2 VALUES ('tmp',3,3);

--error ER_GET_ERRMSG
DELETE FROM t2 where b = 3;

--error ER_GET_ERRMSG
DELETE FROM t2 where id = 3;

--error ER_GET_ERRMSG
UPDATE t2 set b = b +1;

OPTIMIZE TABLE t2;

--error ER_GET_ERRMSG
ALTER TABLE t2 ADD COLUMN d INT;

ANALYZE TABLE t2;

--error ER_GET_ERRMSG
TRUNCATE TABLE t2;

DROP TABLE t2;
--enable_warnings

--echo
--echo # Start server with keys2.txt
--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
-- let $restart_parameters=restart:--keyring-file-data=$MYSQLTEST_VARDIR/std_data/keys2.txt
-- source include/restart_mysqld.inc
