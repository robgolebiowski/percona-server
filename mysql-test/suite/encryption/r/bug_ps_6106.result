CREATE TABLE t1 (id INT NOT NULL PRIMARY KEY, a VARCHAR(255)) ENGINE=InnoDB ENCRYPTION='KEYRING';
CREATE TABLE t2 (id INT NOT NULL PRIMARY KEY, a VARCHAR(255)) ENGINE=InnoDB COMPRESSION="zlib";
CREATE TABLE t3 (id INT NOT NULL PRIMARY KEY, a VARCHAR(255)) ENGINE=InnoDB;
CREATE TABLE t4 (id INT NOT NULL PRIMARY KEY, a VARCHAR(255)) ENGINE=InnoDB ENCRYPTION='N';
CREATE TABLE t4_dup LIKE t4;
SHOW CREATE TABLE t4_dup;
Table	Create Table
t4_dup	CREATE TABLE `t4_dup` (
  `id` int(11) NOT NULL,
  `a` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
CREATE PROCEDURE innodb_insert_proc(repeat_count INT)
BEGIN
DECLARE current_num INT;
SET current_num = 0;
WHILE current_num < repeat_count DO
INSERT INTO t1 VALUES (current_num, REPEAT('foobar', 42));
INSERT INTO t2 VALUES (current_num, REPEAT('temp'  , 42));
INSERT INTO t3 VALUES (current_num, REPEAT('barfoo', 42));
INSERT INTO t4 VALUES (current_num, REPEAT('secret', 42));
INSERT INTO t4_dup VALUES (current_num, REPEAT('fbar', 42));
SET current_num = current_num + 1;
END WHILE;
END//
COMMIT;
SET autocommit = 0;
CALL innodb_insert_proc(10000);
COMMIT;
SET autocommit = 1;
# Wait max 2 min for key encryption threads to encrypt all spaces
include/assert.inc [Make sure t4 is not encrypted]
include/assert.inc [Make sure t4_dup is not encrypted]
ALTER TABLE t1 ENGINE InnoDB;
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` int(11) NOT NULL,
  `a` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='KEYRING' ENCRYPTION_KEY_ID=0
ALTER TABLE t2 ENGINE InnoDB;
SHOW CREATE TABLE t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `id` int(11) NOT NULL,
  `a` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMPRESSION='zlib' ENCRYPTION_KEY_ID=0
ALTER TABLE t3 ENGINE InnoDB;
SHOW CREATE TABLE t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `id` int(11) NOT NULL,
  `a` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION_KEY_ID=0
ALTER TABLE t4 ENGINE InnoDB;
SHOW CREATE TABLE t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `id` int(11) NOT NULL,
  `a` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
ALTER TABLE t4_dup ENGINE InnoDB;
SHOW CREATE TABLE t4_dup;
Table	Create Table
t4_dup	CREATE TABLE `t4_dup` (
  `id` int(11) NOT NULL,
  `a` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
include/assert.inc [Make sure t1 is encrypted]
include/assert.inc [Make sure t2 is encrypted]
include/assert.inc [Make sure t3 is encrypted]
include/assert.inc [Make sure t4 is not encrypted, before bug fix this would fail, because t4 would get encrypted]
include/assert.inc [Make sure t4_dup is not encrypted]
# Tablespaces, apart from t4 should be encrypted after restart
DROP TABLE t1,t2,t3,t4,t4_dup;
DROP PROCEDURE innodb_insert_proc;
