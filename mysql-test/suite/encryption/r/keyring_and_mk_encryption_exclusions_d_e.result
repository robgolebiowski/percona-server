SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE DATABASE db_1;
SHOW CREATE DATABASE db_1;
Database	Create Database
db_1	CREATE DATABASE `db_1` /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci */ /*!80016 DEFAULT ENCRYPTION='N' */
USE db_1;
CREATE TABLE t1 (a varchar(255));
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` varchar(255) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT * FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION;
SPACE	NAME	EXCLUDED	ENCRYPTION_SCHEME	KEYSERVER_REQUESTS	MIN_KEY_VERSION	CURRENT_KEY_VERSION	KEY_ROTATION_PAGE_NUMBER	KEY_ROTATION_MAX_PAGE_NUMBER	CURRENT_KEY_ID	ROTATING_OR_FLUSHING
4	db_1/t1	N	1	0	1	1	NULL	NULL	0	0
SELECT * from INFORMATION_SCHEMA.INNODB_TABLESPACES;
SPACE	NAME	FLAG	ROW_FORMAT	PAGE_SIZE	ZIP_PAGE_SIZE	SPACE_TYPE	FS_BLOCK_SIZE	FILE_SIZE	ALLOCATED_SIZE	SERVER_VERSION	SPACE_VERSION	ENCRYPTION	STATE
4294967294	mysql	18432	Any	16384	0	General	4096	25165824	25165824	8.0.18	1	N	normal
0	innodb_system	18432	Any	16384	0	System	0	0	0	8.0.18	1	N	normal
4294967293	innodb_temporary	4096	Any	16384	0	System	0	0	0	8.0.18	1	N	normal
4294967279	innodb_undo_001	0	Undo	16384	0	Undo	4096	10485760	10485760	8.0.18	1	N	active
4294967278	innodb_undo_002	0	Undo	16384	0	Undo	4096	10485760	10485760	8.0.18	1	N	active
1	sys/sys_config	16417	Dynamic	16384	0	Single	4096	114688	114688	8.0.18	1	N	normal
2	mtr/test_suppressions	16417	Dynamic	16384	0	Single	4096	114688	114688	8.0.18	1	N	normal
3	mtr/global_suppressions	16417	Dynamic	16384	0	Single	4096	114688	114688	8.0.18	1	N	normal
4	db_1/t1	24609	Dynamic	16384	0	Single	4096	114688	16384	8.0.18	1	Y	normal
include/assert.inc [Make sure ENCRYPTION is set to Y in INFORMATION_SCHEMA.INNODB_TABLESPACES]
include/assert.inc [Make sure MIN_KEY_VERSION is set to 1 in INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION]
CREATE DATABASE db_2 DEFAULT ENCRYPTION='Y';
ERROR HY000: Database default encryption cannot be set to Y (Master Key encryption) while default_table_encryption is set to ONLINE_TO_KEYRING. It does not make sense to create new Master Key encrypted tables if the intention is to re-encrypt them to KEYRING encryption.
CREATE DATABASE db_2 DEFAULT ENCRYPTION='N';
ERROR HY000: Database default encryption cannot be set to N (explicitly request for tables in database to be unencrypted) while default_table_encryption is set to ONLINE_TO_KEYRING. If you want to exclude table from being encrypted by encryption threads you can still do it while creating table. For that you need to explicitly specify ENCRYPTION='N' while creating a table.
SET SESSION default_table_encryption=ON;
CREATE DATABASE db_2;
SHOW CREATE DATABASE db_2;
Database	Create Database
db_2	CREATE DATABASE `db_2` /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci */ /*!80016 DEFAULT ENCRYPTION='Y' */
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
USE db_2;
CREATE TABLE t1 (a varchar(255));
ERROR HY000: InnoDB: ENCRYPTED='Y' not supported for table because online encryption to KEYRING is turned ON.
SET GLOBAL default_table_encryption=ONLINE_FROM_KEYRING_TO_UNENCRYPTED;
CREATE TABLE t1 (a varchar(255));
CREATE DATABASE db_3 DEFAULT ENCRYPTION='N';
USE db_3;
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLE t1 (a varchar(255));
CREATE TABLE t2 (a varchar(255)) ENCRYPTION='N';
include/assert.inc [Make sure ENCRYPTION is set to Y in INFORMATION_SCHEMA.INNODB_TABLESPACES for db_3/t1]
include/assert.inc [Make sure MIN_KEY_VERSION is set to 1 in INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION for db_3/t1]
include/assert.inc [Make sure ENCRYPTION is set to N in INFORMATION_SCHEMA.INNODB_TABLESPACES for db_3/t2]
include/assert.inc [Make sure EXCLUDED is set to Y in INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION for db_3/t2]
SET GLOBAL default_table_encryption=ONLINE_FROM_KEYRING_TO_UNENCRYPTED;
CREATE TABLE t3 (a varchar(255));
# Make sure db_3/t3 is not included in INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION as it was never encrypted nor
# excluded from encryption threads.
include/assert.inc [Make sure db_3/t3 is not included in INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION]
SET GLOBAL default_table_encryption=ONLINE_FROM_KEYRING_TO_UNENCRYPTED;
CREATE DATABASE db_4 DEFAULT ENCRYPTION='Y';
USE db_4;
CREATE TABLE t1 (a varchar(255));
# Make sure db_4/t1 is not included in INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION as it is
# MK encrypted.
include/assert.inc [Make sure db_4/t1 is not included in INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION]
CREATE DATABASE db_5 DEFAULT ENCRYPTION='N';
USE db_5;
CREATE TABLE t1 (a varchar(255));
# Make sure db_5/t1 is not included in INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION as it is
# MK encrypted.
include/assert.inc [Make sure db_5/t1 is not included in INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION]
SET GLOBAL default_table_encryption=OFF;
DROP DATABASE db_1;
DROP DATABASE db_2;
DROP DATABASE db_3;
DROP DATABASE db_4;
DROP DATABASE db_5;
