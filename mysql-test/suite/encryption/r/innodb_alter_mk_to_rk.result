SET @@global.keyring_file_data="MYSQL_TMP_DIR/mysecret_keyring";
SHOW PLUGINS;
Name	Status	Type	Library	License
keyring_file	ACTIVE	KEYRING	keyring_file.so	GPL
binlog	ACTIVE	STORAGE ENGINE	NULL	GPL
mysql_native_password	ACTIVE	AUTHENTICATION	NULL	GPL
sha256_password	ACTIVE	AUTHENTICATION	NULL	GPL
PERFORMANCE_SCHEMA	ACTIVE	STORAGE ENGINE	NULL	GPL
CSV	ACTIVE	STORAGE ENGINE	NULL	GPL
MEMORY	ACTIVE	STORAGE ENGINE	NULL	GPL
InnoDB	ACTIVE	STORAGE ENGINE	NULL	GPL
XTRADB_READ_VIEW	ACTIVE	INFORMATION SCHEMA	NULL	GPL
XTRADB_INTERNAL_HASH_TABLES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
XTRADB_RSEG	ACTIVE	INFORMATION SCHEMA	NULL	GPL
XTRADB_ZIP_DICT	ACTIVE	INFORMATION SCHEMA	NULL	GPL
XTRADB_ZIP_DICT_COLS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_TRX	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_LOCKS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_LOCK_WAITS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMP	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMP_RESET	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMPMEM	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMPMEM_RESET	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMP_PER_INDEX	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMP_PER_INDEX_RESET	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_BUFFER_PAGE	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_BUFFER_PAGE_LRU	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_BUFFER_POOL_STATS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_TEMP_TABLE_INFO	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_METRICS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_DEFAULT_STOPWORD	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_DELETED	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_BEING_DELETED	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_CONFIG	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_INDEX_CACHE	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_INDEX_TABLE	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SYS_TABLES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SYS_TABLESTATS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SYS_INDEXES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SYS_COLUMNS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SYS_FIELDS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SYS_FOREIGN	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SYS_FOREIGN_COLS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SYS_TABLESPACES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SYS_DATAFILES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CHANGED_PAGES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SYS_VIRTUAL	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_TABLESPACES_ENCRYPTION	ACTIVE	INFORMATION SCHEMA	NULL	BSD
INNODB_TABLESPACES_SCRUBBING	ACTIVE	INFORMATION SCHEMA	NULL	BSD
MyISAM	ACTIVE	STORAGE ENGINE	NULL	GPL
MRG_MYISAM	ACTIVE	STORAGE ENGINE	NULL	GPL
ARCHIVE	ACTIVE	STORAGE ENGINE	NULL	GPL
BLACKHOLE	ACTIVE	STORAGE ENGINE	NULL	GPL
FEDERATED	DISABLED	STORAGE ENGINE	NULL	GPL
partition	ACTIVE	STORAGE ENGINE	NULL	GPL
ngram	ACTIVE	FTPARSER	NULL	GPL
SET GLOBAL innodb_file_per_table = ON;
SET GLOBAL innodb_file_format = `Barracuda`;
create table t1 (a varchar(255)) engine=innodb;
include/assert.inc [Table t1 should be included in INNODB_TABLESPACES_ENCRYPTION yet - since it is not RK]
insert t1 values (repeat('foobarsecret', 12));
select * from t1;
a
foobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecret
# 1. Alter from unencrypted to RK
ALTER TABLE t1 encryption='KEYRING';
SELECT * FROM t1;
a
foobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecret
include/assert.inc [Table t1 should be the only one appearing in INNODB_TABLESPACES_ENCRYPTION]
include/assert.inc [Table t1 should be the only one appearing in INNODB_TABLESPACES_ENCRYPTION]
create table t2 (a varchar(255)) engine=innodb encryption='y';
insert t2 values (repeat('foobarsecret', 12));
include/assert.inc [Table t2 should be included in INNODB_TABLESPACES_ENCRYPTION yet - since it is not RK]
# 2. Alter from MK encryption to RK
ALTER TABLE t2 encryption='KEYRING';
SELECT * FROM t2;
a
foobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecret
include/assert.inc [Table t2 should be included in INNODB_TABLESPACES_ENCRYPTION with MIN_KEY_VERION 1 (encrypted)]
# 3. Alter from RK to MK
ALTER TABLE t1 encryption='Y';
SELECT * FROM t1;
a
foobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecret
include/assert.inc [Table t1 has been re-encrypted to Master key encryption - should disappear from INNODB_TABLESPACES_ENCRYPTION => thus only t2 should remain]
# 4. Alter from MK to unencrypted
ALTER TABLE t1 encryption='n';
include/assert.inc [t1 should be marked as unencrypted in INNODB_TABLESPACES_ENCRYPTION]
# 5. Alter from unencrypted to RK
ALTER TABLE t1 encryption='KEYRING';
include/assert.inc [Table t1 should be included in INNODB_TABLESPACES_ENCRYPTION]
# 6. Alter from RK to unencrypted
ALTER TABLE t1 encryption='n';
include/assert.inc [Table t1 should appear in INNODB_TABLESPACES_ENCRYPTION but with MIN_KEY_VERSION marked as UNENCRYPTED]
drop table t1,t2;
