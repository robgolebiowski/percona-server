SET @@global.keyring_file_data="MYSQL_TMP_DIR/mysecret_keyring";
SHOW PLUGINS;
Name	Status	Type	Library	License
keyring_file	ACTIVE	KEYRING	keyring_file.so	GPL
binlog	ACTIVE	STORAGE ENGINE	NULL	GPL
mysql_native_password	ACTIVE	AUTHENTICATION	NULL	GPL
sha256_password	ACTIVE	AUTHENTICATION	NULL	GPL
caching_sha2_password	ACTIVE	AUTHENTICATION	NULL	GPL
sha2_cache_cleaner	ACTIVE	AUDIT	NULL	GPL
PERFORMANCE_SCHEMA	ACTIVE	STORAGE ENGINE	NULL	GPL
CSV	ACTIVE	STORAGE ENGINE	NULL	GPL
MEMORY	ACTIVE	STORAGE ENGINE	NULL	GPL
InnoDB	ACTIVE	STORAGE ENGINE	NULL	GPL
INNODB_TRX	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMP	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMP_RESET	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMPMEM	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMPMEM_RESET	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMP_PER_INDEX	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMP_PER_INDEX_RESET	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_BUFFER_PAGE	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_BUFFER_PAGE_LRU	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_BUFFER_POOL_STATS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_TEMP_TABLE_INFO	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_METRICS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_DEFAULT_STOPWORD	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_DELETED	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_BEING_DELETED	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_CONFIG	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_INDEX_CACHE	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_INDEX_TABLE	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_TABLES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_TABLESTATS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_INDEXES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_TABLESPACES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_COLUMNS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_VIRTUAL	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CACHED_INDEXES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SESSION_TEMP_TABLESPACES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_TABLESPACES_ENCRYPTION	ACTIVE	INFORMATION SCHEMA	NULL	BSD
INNODB_TABLESPACES_SCRUBBING	ACTIVE	INFORMATION SCHEMA	NULL	BSD
INNODB_CHANGED_PAGES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
MyISAM	ACTIVE	STORAGE ENGINE	NULL	GPL
MRG_MYISAM	ACTIVE	STORAGE ENGINE	NULL	GPL
TempTable	ACTIVE	STORAGE ENGINE	NULL	GPL
ARCHIVE	ACTIVE	STORAGE ENGINE	NULL	GPL
BLACKHOLE	ACTIVE	STORAGE ENGINE	NULL	GPL
FEDERATED	DISABLED	STORAGE ENGINE	NULL	GPL
ngram	ACTIVE	FTPARSER	NULL	GPL
mysqlx	ACTIVE	DAEMON	NULL	GPL
mysqlx_cache_cleaner	ACTIVE	AUDIT	NULL	GPL
SET GLOBAL innodb_file_per_table = ON;
create table t1 (a varchar(255)) engine=innodb encryption='Y';
insert t1 values (repeat('foobarsecret', 12));
select * from t1;
a
foobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecret
SET GLOBAL innodb_encrypt_tables = ONLINE_TO_KEYRING;
# Wait max 10 min for key encryption threads to encrypt all spaces
6
SELECT COUNT(*) FROM INFORMATION_SCHEMA.INNODB_TABLESPACES WHERE FLAG = 8225;
COUNT(*)
0
SELECT * FROM INFORMATION_SCHEMA.INNODB_TABLESPACES;
SPACE	NAME	FLAG	ROW_FORMAT	PAGE_SIZE	ZIP_PAGE_SIZE	SPACE_TYPE	FS_BLOCK_SIZE	FILE_SIZE	ALLOCATED_SIZE	SERVER_VERSION	SPACE_VERSION	ENCRYPTION
4294967294	mysql	26624	Any	16384	0	General	4096	25165824	25165824	8.0.13	1	Y
4294967293	innodb_temporary	4096	Compact or Redundant	16384	0	System	0	0	0	8.0.13	1	N
4294967279	innodb_undo_001	8192	Compact or Redundant	16384	0	Single	0	0	0	8.0.13	1	Y
4294967278	innodb_undo_002	8192	Compact or Redundant	16384	0	Single	0	0	0	8.0.13	1	Y
1	sys/sys_config	24609	Dynamic	16384	0	Single	4096	114688	114688	8.0.13	1	Y
2	test/t1	24609	Dynamic	16384	0	Single	4096	114688	81920	8.0.13	1	Y
include/assert.inc [All encrypted tables should have encrypted flag set apart from temporary tablespace]
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 0;
NAME	MIN_KEY_VERSION
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;
NAME	MIN_KEY_VERSION
mysql	1
innodb_system	1
innodb_undo_001	1
innodb_undo_002	1
sys/sys_config	1
test/t1	1
SELECT * FROM INFORMATION_SCHEMA.INNODB_TABLESPACES;
SPACE	NAME	FLAG	ROW_FORMAT	PAGE_SIZE	ZIP_PAGE_SIZE	SPACE_TYPE	FS_BLOCK_SIZE	FILE_SIZE	ALLOCATED_SIZE	SERVER_VERSION	SPACE_VERSION	ENCRYPTION
4294967294	mysql	26624	Any	16384	0	General	4096	25165824	25165824	8.0.13	1	Y
4294967293	innodb_temporary	4096	Compact or Redundant	16384	0	System	0	0	0	8.0.13	1	N
4294967279	innodb_undo_001	8192	Compact or Redundant	16384	0	Single	0	0	0	8.0.13	1	Y
4294967278	innodb_undo_002	8192	Compact or Redundant	16384	0	Single	0	0	0	8.0.13	1	Y
1	sys/sys_config	24609	Dynamic	16384	0	Single	4096	114688	114688	8.0.13	1	Y
2	test/t1	24609	Dynamic	16384	0	Single	4096	114688	81920	8.0.13	1	Y
# t1 yes on expecting NOT FOUND
# restart:--early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=/home/rob/git/8_0_bld/mysql-test/var/tmp/mysecret_keyring --plugin-dir=/home/rob/git/8_0_bld/plugin_output_directory --innodb-encrypt-tables=ON --innodb-encryption-rotate-key-age=15 --innodb-encryption-threads=1
# Now turn off encryption and wait for threads to decrypt everything
# HERE ROBERT
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 0;
NAME	MIN_KEY_VERSION
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;
NAME	MIN_KEY_VERSION
mysql	1
innodb_system	1
innodb_undo_001	1
innodb_undo_002	1
sys/sys_config	1
test/t1	1
SELECT * FROM INFORMATION_SCHEMA.INNODB_TABLESPACES;
SPACE	NAME	FLAG	ROW_FORMAT	PAGE_SIZE	ZIP_PAGE_SIZE	SPACE_TYPE	FS_BLOCK_SIZE	FILE_SIZE	ALLOCATED_SIZE	SERVER_VERSION	SPACE_VERSION	ENCRYPTION
4294967294	mysql	26624	Any	16384	0	General	4096	25165824	25165824	8.0.13	1	Y
4294967293	innodb_temporary	4096	Compact or Redundant	16384	0	System	0	0	0	8.0.13	1	N
4294967279	innodb_undo_001	8192	Compact or Redundant	16384	0	Single	0	0	0	8.0.13	1	Y
4294967278	innodb_undo_002	8192	Compact or Redundant	16384	0	Single	0	0	0	8.0.13	1	Y
1	sys/sys_config	24609	Dynamic	16384	0	Single	4096	114688	114688	8.0.13	1	Y
2	test/t1	24609	Dynamic	16384	0	Single	4096	114688	81920	8.0.13	1	Y
SET GLOBAL innodb_encrypt_tables = ONLINE_FROM_KEYRING_TO_UNENCRYPTED;
# Wait max 10 min for key encryption threads to decrypt all spaces (but t1 and t4 for which encryption was overriden to yes)
# Only two tables should stayed encrypted - the ones with explicite encryption
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 0;
NAME	MIN_KEY_VERSION
mysql	0
innodb_system	0
innodb_undo_001	0
innodb_undo_002	0
sys/sys_config	0
test/t1	0
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;
NAME	MIN_KEY_VERSION
SELECT * FROM INFORMATION_SCHEMA.INNODB_TABLESPACES;
SPACE	NAME	FLAG	ROW_FORMAT	PAGE_SIZE	ZIP_PAGE_SIZE	SPACE_TYPE	FS_BLOCK_SIZE	FILE_SIZE	ALLOCATED_SIZE	SERVER_VERSION	SPACE_VERSION	ENCRYPTION
4294967294	mysql	18432	Any	16384	0	General	4096	25165824	25165824	8.0.13	1	N
4294967293	innodb_temporary	4096	Compact or Redundant	16384	0	System	0	0	0	8.0.13	1	N
4294967279	innodb_undo_001	0	Compact or Redundant	16384	0	Single	0	0	0	8.0.13	1	N
4294967278	innodb_undo_002	0	Compact or Redundant	16384	0	Single	0	0	0	8.0.13	1	N
1	sys/sys_config	16417	Dynamic	16384	0	Single	4096	114688	114688	8.0.13	1	N
2	test/t1	16417	Dynamic	16384	0	Single	4096	114688	81920	8.0.13	1	N
include/assert.inc [There should be no encrypted tables left]
SELECT NAME, MIN_KEY_VERSION, ROTATING_OR_FLUSHING FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 0;
NAME	MIN_KEY_VERSION	ROTATING_OR_FLUSHING
mysql	0	0
innodb_system	0	0
innodb_undo_001	0	0
innodb_undo_002	0	0
sys/sys_config	0	0
test/t1	0	0
SELECT NAME, MIN_KEY_VERSION, ROTATING_OR_FLUSHING FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;
NAME	MIN_KEY_VERSION	ROTATING_OR_FLUSHING
# t1 yes on expecting NOT FOUND
# restart:--early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=/home/rob/git/8_0_bld/mysql-test/var/tmp/mysecret_keyring --plugin-dir=/home/rob/git/8_0_bld/plugin_output_directory --innodb-encrypt-tables=ON --innodb-encryption-rotate-key-age=15 --innodb-encryption-threads=4
# Now turn on encryption and wait for threads to encrypt all spaces
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;
NAME	MIN_KEY_VERSION
SET GLOBAL innodb_encrypt_tables = ONLINE_TO_KEYRING;
# Wait max 10 min for key encryption threads to encrypt all spaces
include/assert.inc [All tables should have been encrypted, apart from temporary tablepsace]
include/assert.inc [temprorary tablespace should be the only one left unencrypted]
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 0;
NAME	MIN_KEY_VERSION
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;
NAME	MIN_KEY_VERSION
mysql	1
innodb_system	1
innodb_undo_001	1
innodb_undo_002	1
sys/sys_config	1
test/t1	1
SELECT * FROM INFORMATION_SCHEMA.INNODB_TABLESPACES;
SPACE	NAME	FLAG	ROW_FORMAT	PAGE_SIZE	ZIP_PAGE_SIZE	SPACE_TYPE	FS_BLOCK_SIZE	FILE_SIZE	ALLOCATED_SIZE	SERVER_VERSION	SPACE_VERSION	ENCRYPTION
4294967294	mysql	26624	Any	16384	0	General	4096	25165824	25165824	8.0.13	1	Y
4294967293	innodb_temporary	4096	Compact or Redundant	16384	0	System	0	0	0	8.0.13	1	N
4294967279	innodb_undo_001	8192	Compact or Redundant	16384	0	Single	0	0	0	8.0.13	1	Y
4294967278	innodb_undo_002	8192	Compact or Redundant	16384	0	Single	0	0	0	8.0.13	1	Y
1	sys/sys_config	24609	Dynamic	16384	0	Single	4096	114688	114688	8.0.13	1	Y
2	test/t1	24609	Dynamic	16384	0	Single	4096	114688	81920	8.0.13	1	Y
# t1 yes on expecting NOT FOUND
# restart:--early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=/home/rob/git/8_0_bld/mysql-test/var/tmp/mysecret_keyring --plugin-dir=/home/rob/git/8_0_bld/plugin_output_directory --innodb-encrypt-tables=ON --innodb-encryption-rotate-key-age=15 --innodb-encryption-threads=4
alter table t1 encryption='n';
# Wait max 10 min for key encryption to decrypt t1
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 0;
NAME	MIN_KEY_VERSION
test/t1	0
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;
NAME	MIN_KEY_VERSION
mysql	1
innodb_system	1
innodb_undo_001	1
innodb_undo_002	1
sys/sys_config	1
SELECT * FROM INFORMATION_SCHEMA.INNODB_TABLESPACES;
SPACE	NAME	FLAG	ROW_FORMAT	PAGE_SIZE	ZIP_PAGE_SIZE	SPACE_TYPE	FS_BLOCK_SIZE	FILE_SIZE	ALLOCATED_SIZE	SERVER_VERSION	SPACE_VERSION	ENCRYPTION
4294967294	mysql	26624	Any	16384	0	General	4096	26214400	26214400	8.0.13	1	Y
4294967293	innodb_temporary	4096	Compact or Redundant	16384	0	System	0	0	0	8.0.13	1	N
4294967279	innodb_undo_001	8192	Compact or Redundant	16384	0	Single	0	0	0	8.0.13	1	Y
4294967278	innodb_undo_002	8192	Compact or Redundant	16384	0	Single	0	0	0	8.0.13	1	Y
1	sys/sys_config	24609	Dynamic	16384	0	Single	4096	114688	114688	8.0.13	1	Y
3	test/t1	16417	Dynamic	16384	0	Single	4096	114688	16384	8.0.13	1	N
include/assert.inc [t1 should got decrypted]
include/assert.inc [also temporary tablespace should stary unenecrypted]
include/assert.inc [t1 and temporary should be the only unencrypted tables]
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 0;
NAME	MIN_KEY_VERSION
test/t1	0
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;
NAME	MIN_KEY_VERSION
mysql	1
innodb_system	1
innodb_undo_001	1
innodb_undo_002	1
sys/sys_config	1
SELECT * FROM INFORMATION_SCHEMA.INNODB_TABLESPACES;
SPACE	NAME	FLAG	ROW_FORMAT	PAGE_SIZE	ZIP_PAGE_SIZE	SPACE_TYPE	FS_BLOCK_SIZE	FILE_SIZE	ALLOCATED_SIZE	SERVER_VERSION	SPACE_VERSION	ENCRYPTION
4294967294	mysql	26624	Any	16384	0	General	4096	26214400	26214400	8.0.13	1	Y
4294967293	innodb_temporary	4096	Compact or Redundant	16384	0	System	0	0	0	8.0.13	1	N
4294967279	innodb_undo_001	8192	Compact or Redundant	16384	0	Single	0	0	0	8.0.13	1	Y
4294967278	innodb_undo_002	8192	Compact or Redundant	16384	0	Single	0	0	0	8.0.13	1	Y
1	sys/sys_config	24609	Dynamic	16384	0	Single	4096	114688	114688	8.0.13	1	Y
3	test/t1	16417	Dynamic	16384	0	Single	4096	114688	16384	8.0.13	1	N
# t1 yes on expecting FOUND
# restart:--early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=/home/rob/git/8_0_bld/mysql-test/var/tmp/mysecret_keyring --plugin-dir=/home/rob/git/8_0_bld/plugin_output_directory --innodb-encrypt-tables=ON --innodb-encryption-rotate-key-age=15 --innodb-encryption-threads=4
drop table t1;
