SET @@global.keyring_file_data="MYSQL_TMP_DIR/mysecret_keyring";
SET GLOBAL innodb_file_per_table = ON;
SET GLOBAL innodb_file_format = `Barracuda`;
create table t1 (a varchar(255)) engine=innodb encryption='Y';
insert t1 values (repeat('foobarsecret', 12));
select * from t1;
a
foobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecret
SET GLOBAL innodb_encrypt_tables=ONLINE_TO_KEYRING;
# which does not exist in INNODB_SYS_TABLESPACES
# Wait max 10 min for key encryption threads to encrypt all spaces
include/assert.inc [All encrypted tables should have encrypted flag set]
# t1 yes on expecting NOT FOUND
# restart:--early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=MYSQL_TMP_DIR/mysecret_keyring KEYRING_PLUGIN_OPT --innodb-encrypt-tables=ONLINE_TO_KEYRING --innodb-encryption-rotate-key-age=15 --innodb-encryption-threads=4
# Now turn off encryption and wait for threads to decrypt everything
SET GLOBAL innodb_encrypt_tables=ONLINE_FROM_KEYRING_TO_UNENCRYPTED;
include/assert.inc [There should be no encrypted tables left]
# restart:--early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=MYSQL_TMP_DIR/mysecret_keyring KEYRING_PLUGIN_OPT --innodb-encrypt-tables=ONLINE_TO_KEYRING --innodb-encryption-rotate-key-age=15 --innodb-encryption-threads=4
# Now turn on encryption and wait for threads to encrypt all spaces
SET GLOBAL innodb_encrypt_tables=ONLINE_TO_KEYRING;
# Wait max 10 min for key encryption threads to encrypt all spaces
include/assert.inc [All tables should have been encrypted]
# restart:--early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=MYSQL_TMP_DIR/mysecret_keyring KEYRING_PLUGIN_OPT --innodb-encrypt-tables=ONLINE_TO_KEYRING --innodb-encryption-rotate-key-age=15 --innodb-encryption-threads=4
alter table t1 encryption='n';
# Wait max 10 min for key encryption threads to encrypt all spaces (apart from t1,t3 and t4)
include/assert.inc [All spaces apart from t1 should got encrypted]
# restart:--early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=MYSQL_TMP_DIR/mysecret_keyring KEYRING_PLUGIN_OPT --innodb-encrypt-tables=ONLINE_TO_KEYRING --innodb-encryption-rotate-key-age=15 --innodb-encryption-threads=4
drop table t1;
