SET @@global.keyring_file_data="MYSQL_TMP_DIR/mysecret_keyring";
SHOW PLUGINS;
Name	Status	Type	Library	License
keyring_file	ACTIVE	KEYRING	keyring_file.so	GPL
binlog	ACTIVE	STORAGE ENGINE	NULL	GPL
mysql_native_password	ACTIVE	AUTHENTICATION	NULL	GPL
sha256_password	ACTIVE	AUTHENTICATION	NULL	GPL
caching_sha2_password	ACTIVE	AUTHENTICATION	NULL	GPL
sha2_cache_cleaner	ACTIVE	AUDIT	NULL	GPL
PERFORMANCE_SCHEMA	ACTIVE	STORAGE ENGINE	NULL	GPL
CSV	ACTIVE	STORAGE ENGINE	NULL	GPL
MEMORY	ACTIVE	STORAGE ENGINE	NULL	GPL
InnoDB	ACTIVE	STORAGE ENGINE	NULL	GPL
INNODB_TRX	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMP	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMP_RESET	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMPMEM	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMPMEM_RESET	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMP_PER_INDEX	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMP_PER_INDEX_RESET	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_BUFFER_PAGE	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_BUFFER_PAGE_LRU	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_BUFFER_POOL_STATS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_TEMP_TABLE_INFO	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_METRICS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_DEFAULT_STOPWORD	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_DELETED	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_BEING_DELETED	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_CONFIG	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_INDEX_CACHE	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_INDEX_TABLE	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_TABLES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_TABLESTATS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_INDEXES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_TABLESPACES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_COLUMNS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_VIRTUAL	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CACHED_INDEXES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SESSION_TEMP_TABLESPACES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_TABLESPACES_ENCRYPTION	ACTIVE	INFORMATION SCHEMA	NULL	BSD
INNODB_TABLESPACES_SCRUBBING	ACTIVE	INFORMATION SCHEMA	NULL	BSD
INNODB_CHANGED_PAGES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
MyISAM	ACTIVE	STORAGE ENGINE	NULL	GPL
MRG_MYISAM	ACTIVE	STORAGE ENGINE	NULL	GPL
TempTable	ACTIVE	STORAGE ENGINE	NULL	GPL
ARCHIVE	ACTIVE	STORAGE ENGINE	NULL	GPL
BLACKHOLE	ACTIVE	STORAGE ENGINE	NULL	GPL
FEDERATED	DISABLED	STORAGE ENGINE	NULL	GPL
ngram	ACTIVE	FTPARSER	NULL	GPL
mysqlx	ACTIVE	DAEMON	NULL	GPL
mysqlx_cache_cleaner	ACTIVE	AUDIT	NULL	GPL
SET GLOBAL innodb_file_per_table = ON;
create table t1 (a varchar(255)) engine=innodb encryption='Y';
insert t1 values (repeat('foobarsecret', 12));
SET GLOBAL innodb_encrypt_tables = ONLINE_TO_KEYRING;
# Wait max 10 min for key encryption threads to encrypt all spaces
6
include/assert.inc [All encrypted tables should have encrypted flag set apart from temporary tablespace]
include/assert.inc [Make sure t1 is present in INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION with MIN_KEY_VERSION = 1]
# restart:--early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=MYSQL_TMP_DIR/mysecret_keyring --plugin-dir=/home/rob/git/8_0_bld/plugin_output_directory --innodb-encrypt-tables=ON --innodb-encryption-rotate-key-age=15 --innodb-encryption-threads=1
# Now turn off encryption and wait for threads to decrypt everything
SET GLOBAL innodb_encrypt_tables = ONLINE_FROM_KEYRING_TO_UNENCRYPTED;
include/assert.inc [There should be no encrypted tables left]
# t1 yes on expecting NOT FOUND
# restart:--early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=MYSQL_TMP_DIR/mysecret_keyring --plugin-dir=/home/rob/git/8_0_bld/plugin_output_directory --innodb-encrypt-tables=ON --innodb-encryption-rotate-key-age=15 --innodb-encryption-threads=4
# Now turn on encryption and wait for threads to encrypt all spaces
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;
NAME	MIN_KEY_VERSION
SET GLOBAL innodb_encrypt_tables = ONLINE_TO_KEYRING;
# Wait max 10 min for key encryption threads to encrypt all spaces
include/assert.inc [All tables should have been encrypted, apart from temporary tablepsace]
include/assert.inc [temprorary tablespace should be the only one left unencrypted]
# restart:--early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=/home/rob/git/8_0_bld/mysql-test/var/tmp/mysecret_keyring --plugin-dir=/home/rob/git/8_0_bld/plugin_output_directory --innodb-encrypt-tables=ON --innodb-encryption-rotate-key-age=15 --innodb-encryption-threads=4
alter table t1 encryption='n';
# Wait max 10 min for key encryption to decrypt t1
include/assert.inc [t1 should got decrypted]
include/assert.inc [also temporary tablespace should stary unenecrypted]
include/assert.inc [t1 and temporary should be the only unencrypted tables]
# restart:--early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=/home/rob/git/8_0_bld/mysql-test/var/tmp/mysecret_keyring --plugin-dir=/home/rob/git/8_0_bld/plugin_output_directory --innodb-encrypt-tables=ON --innodb-encryption-rotate-key-age=15 --innodb-encryption-threads=4
drop table t1;
SET GLOBAL innodb_encrypt_tables = ONLINE_FROM_KEYRING_TO_UNENCRYPTED;
# Wait max 10 min for encryption threads to decrypt all tables
SET GLOBAL innodb_encrypt_tables = OFF;
