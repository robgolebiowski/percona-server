call mtr.add_suppression("InnoDB: The page \\[page id: space=[1-9][0-9]*, page number=[1-9][0-9]*\\] in file '.*test.t[12]\\.ibd' cannot be decrypted\\. Are you using correct keyring?");
call mtr.add_suppression("\\[InnoDB\\] The page \\[page id: space=4, page number=[4-5]\\] in file '\./test/t2\.ibd' cannot be decrypted\. Are you using correct keyring?");
call mtr.add_suppression("\\[Warning\\] InnoDB: Cannot save statistics for table `test`\.`t2` because file \./test/t2\.ibd cannot be decrypted\.");
call mtr.add_suppression("\\[InnoDB\\] Tablespace id 3 in file t1.ibd is encrypted but keyring or used key_id 2 is not available. Can't continue reading table. Please provide the correct keyring\.");
# Start server with keys2.txt
# restart:--keyring-file-data=MYSQLTEST_VARDIR/std_data/keys2.txt
SET GLOBAL innodb_file_per_table = ON;
CREATE TABLE t1 (c VARCHAR(8)) ENGINE=InnoDB ENCRYPTION='KEYRING' ENCRYPTION_KEY_ID=2;
INSERT INTO t1 VALUES ('foobar');
ALTER TABLE t1 ADD COLUMN c2 INT;
INSERT INTO t1 VALUES ('foobar',2);
SELECT * FROM t1;
c	c2
foobar	NULL
foobar	2
TRUNCATE TABLE t1;
SELECT * FROM t1;
c	c2
INSERT INTO t1 VALUES ('foobar',1);
INSERT INTO t1 VALUES ('foobar',2);
FLUSH TABLE WITH READ LOCK;
SELECT * FROM t1;
c	c2
foobar	1
foobar	2
# Make sure that there is no error in error log related to missing key for t1

# Restart server with keysbad3.txt
# restart:--keyring-file-data=MYSQLTEST_VARDIR/std_data/keysbad3.txt
SELECT * FROM t1;
ERROR HY000: Got error 501 'Table encrypted but decryption key was not found. Is correct keyring loaded?' from InnoDB
DROP TABLE t1;
# Start server with keys3.txt
# restart:--keyring-file-data=MYSQLTEST_VARDIR/std_data/keys3.txt
SET GLOBAL innodb_stats_persistent=OFF;
SET SESSION innodb_default_encryption_key_id=5;
CREATE TABLE t2 (c VARCHAR(8), id int not null primary key, b int, key(b)) ENGINE=InnoDB ENCRYPTION='KEYRING';
INSERT INTO t2 VALUES ('foobar',1,2);

# Restart server with keys2.txt
# restart:--keyring-file-data=MYSQLTEST_VARDIR/std_data/keys2.txt
SET GLOBAL innodb_stats_persistent=ON;
SELECT * FROM t2;
ERROR HY000: Got error 500 'Table encrypted but decryption failed. This could be because correct encryption management plugin is not loaded, used encryption key is not available or encryption method does not match.' from InnoDB
SELECT * FROM t2 where id = 1;
ERROR HY000: Got error 500 'Table encrypted but decryption failed. This could be because correct encryption management plugin is not loaded, used encryption key is not available or encryption method does not match.' from InnoDB
SELECT * FROM t2 where b = 1;
ERROR HY000: Got error 500 'Table encrypted but decryption failed. This could be because correct encryption management plugin is not loaded, used encryption key is not available or encryption method does not match.' from InnoDB
INSERT INTO t2 VALUES ('tmp',3,3);
ERROR HY000: Got error 500 'Table encrypted but decryption failed. This could be because correct encryption management plugin is not loaded, used encryption key is not available or encryption method does not match.' from InnoDB
DELETE FROM t2 where b = 3;
ERROR HY000: Got error 500 'Table encrypted but decryption failed. This could be because correct encryption management plugin is not loaded, used encryption key is not available or encryption method does not match.' from InnoDB
DELETE FROM t2 where id = 3;
ERROR HY000: Got error 500 'Table encrypted but decryption failed. This could be because correct encryption management plugin is not loaded, used encryption key is not available or encryption method does not match.' from InnoDB
UPDATE t2 set b = b +1;
ERROR HY000: Got error 500 'Table encrypted but decryption failed. This could be because correct encryption management plugin is not loaded, used encryption key is not available or encryption method does not match.' from InnoDB
OPTIMIZE TABLE t2;
Table	Op	Msg_type	Msg_text
test.t2	optimize	Error	Got error 500 'Table encrypted but decryption failed. This could be because correct encryption management plugin is not loaded, used encryption key is not available or encryption method does not match.' from InnoDB
test.t2	optimize	error	Corrupt
ALTER TABLE t2 ADD COLUMN d INT;
ERROR HY000: Got error 500 'Table encrypted but decryption failed. This could be because correct encryption management plugin is not loaded, used encryption key is not available or encryption method does not match.' from InnoDB
ANALYZE TABLE t2;
Table	Op	Msg_type	Msg_text
test.t2	analyze	Error	Got error 500 'Table encrypted but decryption failed. This could be because correct encryption management plugin is not loaded, used encryption key is not available or encryption method does not match.' from InnoDB
test.t2	analyze	error	Corrupt
TRUNCATE TABLE t2;
ERROR HY000: Got error 500 'Table encrypted but decryption failed. This could be because correct encryption management plugin is not loaded, used encryption key is not available or encryption method does not match.' from InnoDB
DROP TABLE t2;

# Start server with keys2.txt
# restart:--keyring-file-data=MYSQLTEST_VARDIR/std_data/keys2.txt
