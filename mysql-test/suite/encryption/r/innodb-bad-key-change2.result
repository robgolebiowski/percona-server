call mtr.add_suppression("\\[ERROR\\] InnoDB: Decryption failed for page");
call mtr.add_suppression("\\[Warning\\] InnoDB: Table is encrypted but encryption service or used key_id is not available");
call mtr.add_suppression("InnoDB: Tablespace for table \`test\`.\`t1\` is set as discarded\\.");
SET GLOBAL innodb_file_per_table = ON;
CREATE TABLE t1 (pk INT PRIMARY KEY, f VARCHAR(8)) ENGINE=InnoDB ENCRYPTION='KEYRING' ENCRYPTION_KEY_ID=4;
INSERT INTO t1 VALUES (1,'foo'),(2,'bar');
# restart:--keyring-file-data=MYSQLTEST_VARDIR/std_data/keys3.txt
SELECT * FROM t1;
ERROR HY000: Got error 500 'Table encrypted but decryption failed. This could be because correct encryption management plugin is not loaded, used encryption key is not available or encryption method does not match.' from InnoDB
SHOW WARNINGS;
Level	Code	Message
Error	1296	Got error 500 'Table encrypted but decryption failed. This could be because correct encryption management plugin is not loaded, used encryption key is not available or encryption method does not match.' from InnoDB
ALTER TABLE t1 ENGINE=InnoDB;
ERROR HY000: Got error 500 'Table encrypted but decryption failed. This could be because correct encryption management plugin is not loaded, used encryption key is not available or encryption method does not match.' from InnoDB
SHOW WARNINGS;
Level	Code	Message
Warning	500	Table t1 in file ./test/t1.ibd is encrypted but encryption service or used key_id is not available.  Can't continue reading table.
Error	1296	Got error 500 'Table encrypted but decryption failed. This could be because correct encryption management plugin is not loaded, used encryption key is not available or encryption method does not match.' from InnoDB
OPTIMIZE TABLE t1;
Table	Op	Msg_type	Msg_text
test.t1	optimize	note	Table does not support optimize, doing recreate + analyze instead
test.t1	optimize	error	Got error 500 'Table encrypted but decryption failed. This could be because correct encryption management plugin is not loaded, used encryption key is not available or encryption method does not match.' from InnoDB
test.t1	optimize	status	Operation failed
Warnings:
Warning	500	Table t1 in file ./test/t1.ibd is encrypted but encryption service or used key_id is not available.  Can't continue reading table.
Error	1296	Got error 500 'Table encrypted but decryption failed. This could be because correct encryption management plugin is not loaded, used encryption key is not available or encryption method does not match.' from InnoDB
SHOW WARNINGS;
Level	Code	Message
Warning	500	Table t1 in file ./test/t1.ibd is encrypted but encryption service or used key_id is not available.  Can't continue reading table.
Error	1296	Got error 500 'Table encrypted but decryption failed. This could be because correct encryption management plugin is not loaded, used encryption key is not available or encryption method does not match.' from InnoDB
CHECK TABLE t1;
Table	Op	Msg_type	Msg_text
test.t1	check	Warning	Table t1 in file ./test/t1.ibd is encrypted but encryption service or used key_id is not available.  Can't continue reading table.
test.t1	check	Error	Got error 500 'Table encrypted but decryption failed. This could be because correct encryption management plugin is not loaded, used encryption key is not available or encryption method does not match.' from InnoDB
test.t1	check	error	Corrupt
SHOW WARNINGS;
Level	Code	Message
# restart:--keyring-file-data=MYSQLTEST_VARDIR/std_data/keys2.txt
FLUSH TABLES t1 FOR EXPORT;
backup: t1
UNLOCK TABLES;
# restart:--keyring-file-data=MYSQLTEST_VARDIR/std_data/keys3.txt
ALTER TABLE t1 DISCARD TABLESPACE;
restore: t1 .ibd and .cfg files
# restart:--keyring-file-data=MYSQLTEST_VARDIR/std_data/keys2.txt
ALTER TABLE t1 IMPORT TABLESPACE;
Warnings:
Warning	1814	InnoDB: Tablespace has been discarded for table 't1'
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `pk` int(11) NOT NULL,
  `f` varchar(8) DEFAULT NULL,
  PRIMARY KEY (`pk`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 ENCRYPTION='KEYRING' ENCRYPTION_KEY_ID=4
# restart: --innodb-encrypt-tables --keyring-file-data=MYSQLTEST_VARDIR/std_data/keys3.txt
RENAME TABLE t1 TO t1new;
# Actually this will fail if innodb_stats_persistent=OFF
# Bug in MariaDB MDEV-17695 : Inconsistent behaviour when stats_persistent enabled and decryption fails
# Traced in percona jira: PS-5011 : Inconsistent behaviour when stats_persistent enabled and decryption fails
ALTER TABLE t1new RENAME TO t2new;
DROP TABLE t2new;
