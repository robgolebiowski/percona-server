SET @@global.keyring_file_data="MYSQL_TMP_DIR/mysecret_keyring";
SHOW PLUGINS;
Name	Status	Type	Library	License
keyring_file	ACTIVE	KEYRING	keyring_file.so	GPL
binlog	ACTIVE	STORAGE ENGINE	NULL	GPL
mysql_native_password	ACTIVE	AUTHENTICATION	NULL	GPL
sha256_password	ACTIVE	AUTHENTICATION	NULL	GPL
PERFORMANCE_SCHEMA	ACTIVE	STORAGE ENGINE	NULL	GPL
CSV	ACTIVE	STORAGE ENGINE	NULL	GPL
MEMORY	ACTIVE	STORAGE ENGINE	NULL	GPL
InnoDB	ACTIVE	STORAGE ENGINE	NULL	GPL
XTRADB_READ_VIEW	ACTIVE	INFORMATION SCHEMA	NULL	GPL
XTRADB_INTERNAL_HASH_TABLES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
XTRADB_RSEG	ACTIVE	INFORMATION SCHEMA	NULL	GPL
XTRADB_ZIP_DICT	ACTIVE	INFORMATION SCHEMA	NULL	GPL
XTRADB_ZIP_DICT_COLS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_TRX	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_LOCKS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_LOCK_WAITS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMP	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMP_RESET	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMPMEM	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMPMEM_RESET	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMP_PER_INDEX	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CMP_PER_INDEX_RESET	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_BUFFER_PAGE	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_BUFFER_PAGE_LRU	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_BUFFER_POOL_STATS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_TEMP_TABLE_INFO	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_METRICS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_DEFAULT_STOPWORD	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_DELETED	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_BEING_DELETED	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_CONFIG	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_INDEX_CACHE	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_FT_INDEX_TABLE	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SYS_TABLES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SYS_TABLESTATS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SYS_INDEXES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SYS_COLUMNS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SYS_FIELDS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SYS_FOREIGN	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SYS_FOREIGN_COLS	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SYS_TABLESPACES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SYS_DATAFILES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_CHANGED_PAGES	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_SYS_VIRTUAL	ACTIVE	INFORMATION SCHEMA	NULL	GPL
INNODB_TABLESPACES_ENCRYPTION	ACTIVE	INFORMATION SCHEMA	NULL	BSD
MyISAM	ACTIVE	STORAGE ENGINE	NULL	GPL
MRG_MYISAM	ACTIVE	STORAGE ENGINE	NULL	GPL
ARCHIVE	ACTIVE	STORAGE ENGINE	NULL	GPL
BLACKHOLE	ACTIVE	STORAGE ENGINE	NULL	GPL
FEDERATED	DISABLED	STORAGE ENGINE	NULL	GPL
partition	ACTIVE	STORAGE ENGINE	NULL	GPL
ngram	ACTIVE	FTPARSER	NULL	GPL
SET GLOBAL innodb_file_per_table = ON;
SET GLOBAL innodb_file_format = `Barracuda`;
create table t1 (a varchar(255)) engine=innodb encryption='ROTATED_KEYS';
create table t2 (a varchar(255)) engine=innodb;
show warnings;
Level	Code	Message
create table t3 (a varchar(255)) engine=innodb encryption='N';
create table t4 (a varchar(255)) engine=innodb encryption='ROTATED_KEYS' encryption_key_id=5;
CREATE TABLESPACE ts_encrypted ADD DATAFILE 'ts_encrypted.ibd' ENCRYPTION="Y" ENGINE="InnoDB";
CREATE TABLE t5 (a varchar(255)) TABLESPACE ts_encrypted ENCRYPTION="Y" ENGINE="InnoDB";
CREATE TABLESPACE ts_rk_encrypted ADD DATAFILE 'ts_rk_encrypted.ibd' ENCRYPTION='ROTATED_KEYS' ENGINE="InnoDB";
ERROR HY000: Invalid encryption option.
create table t6 (a varchar(255)) engine=innodb;
insert t1 values (repeat('foobarsecret', 12));
insert t2 values (repeat('tempsecret', 12));
insert t3 values (repeat('dummysecret', 12));
insert t4 values (repeat('verysecret', 12));
insert t5 values (repeat('moresecret', 12));
insert t6 values (repeat('sooosecret', 12));
select * from t1;
a
foobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecretfoobarsecret
select * from t2;
a
tempsecrettempsecrettempsecrettempsecrettempsecrettempsecrettempsecrettempsecrettempsecrettempsecrettempsecrettempsecret
select * from t3;
a
dummysecretdummysecretdummysecretdummysecretdummysecretdummysecretdummysecretdummysecretdummysecretdummysecretdummysecretdummysecret
select * from t4;
a
verysecretverysecretverysecretverysecretverysecretverysecretverysecretverysecretverysecretverysecretverysecretverysecret
select * from t5;
a
moresecretmoresecretmoresecretmoresecretmoresecretmoresecretmoresecretmoresecretmoresecretmoresecretmoresecretmoresecret
select * from t6;
a
sooosecretsooosecretsooosecretsooosecretsooosecretsooosecretsooosecretsooosecretsooosecretsooosecretsooosecretsooosecret
ALTER TABLE t4 ENCRYPTION='N', ALGORITHM=INPLACE;
SELECT * FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION;
SPACE	NAME	ENCRYPTION_SCHEME	KEYSERVER_REQUESTS	MIN_KEY_VERSION	CURRENT_KEY_VERSION	KEY_ROTATION_PAGE_NUMBER	KEY_ROTATION_MAX_PAGE_NUMBER	CURRENT_KEY_ID	ROTATING_OR_FLUSHING
2	mysql/plugin	1	0	1	1	NULL	NULL	0	0
3	mysql/servers	1	0	1	1	NULL	NULL	0	0
5	mysql/help_category	1	0	1	1	NULL	NULL	0	0
7	mysql/help_keyword	1	0	0	1	0	0	0	1
11	mysql/time_zone_transition_type	1	0	1	1	NULL	NULL	0	0
13	mysql/innodb_table_stats	1	0	1	1	NULL	NULL	0	0
15	mysql/slave_relay_log_info	1	0	1	1	NULL	NULL	0	0
16	mysql/slave_master_info	1	0	1	1	NULL	NULL	0	0
17	mysql/slave_worker_info	1	0	1	1	NULL	NULL	0	0
18	mysql/gtid_executed	1	0	1	1	NULL	NULL	0	0
19	mysql/server_cost	1	0	1	1	NULL	NULL	0	0
20	mysql/engine_cost	1	0	1	1	NULL	NULL	0	0
21	sys/sys_config	1	0	1	1	NULL	NULL	0	0
23	test/t1	1	0	1	1	NULL	NULL	0	0
24	test/t2	1	0	1	1	NULL	NULL	0	0
25	test/t3	0	0	0	1	NULL	NULL	0	0
27	ts_encrypted	1	0	1	1	NULL	NULL	0	0
28	test/t6	1	0	1	1	NULL	NULL	0	0
29	test/t4	0	0	0	1	NULL	NULL	5	0
0	innodb_system	1	0	0	1	841	768	0	1
ALTER TABLE t4 ENCRYPTION='ROTATED_KEYS', ALGORITHM=INPLACE;
# ibdata1 expecting NOT_FOUND
# It should be possible to mark table as not encrypted with INPLACE algorithm, given table is
# is currently not encrypted
ALTER TABLE t6 ENCRYPTION='N', ALGORITHM=INPLACE;
ALTER TABLE t6 ENCRYPTION='ROTATED_KEYS', ALGORITHM=INPLACE;
# Wait max 10 min for key encryption threads to encrypt all spaces

SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLESPACES;
SPACE	NAME	FLAG	FILE_FORMAT	ROW_FORMAT	PAGE_SIZE	ZIP_PAGE_SIZE	SPACE_TYPE	FS_BLOCK_SIZE	FILE_SIZE	ALLOCATED_SIZE
2	mysql/plugin	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
3	mysql/servers	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
4	mysql/help_topic	8225	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
5	mysql/help_category	8225	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
6	mysql/help_relation	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
7	mysql/help_keyword	8225	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
8	mysql/time_zone_name	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
9	mysql/time_zone	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
10	mysql/time_zone_transition	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
11	mysql/time_zone_transition_type	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
12	mysql/time_zone_leap_second	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
13	mysql/innodb_table_stats	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
14	mysql/innodb_index_stats	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
15	mysql/slave_relay_log_info	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
16	mysql/slave_master_info	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
17	mysql/slave_worker_info	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
18	mysql/gtid_executed	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
19	mysql/server_cost	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
20	mysql/engine_cost	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
21	sys/sys_config	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
23	test/t1	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
24	test/t2	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
25	test/t3	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
27	ts_encrypted	10240	Any	Any	16384	0	General	4096	98304	98304
30	test/t4	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
32	test/t6	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
SELECT COUNT(*) FROM INFORMATION_SCHEMA.INNODB_SYS_TABLESPACES WHERE FLAG = 8225;
COUNT(*)
24
include/assert.inc [All encrypted tables should have encrypted flag set, apart from t3]
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 0;
NAME	MIN_KEY_VERSION
test/t3	0
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;
NAME	MIN_KEY_VERSION
mysql/plugin	1
mysql/servers	1
mysql/help_topic	1
mysql/help_category	1
mysql/help_relation	1
mysql/help_keyword	1
mysql/time_zone_name	1
mysql/time_zone	1
mysql/time_zone_transition	1
mysql/time_zone_transition_type	1
mysql/time_zone_leap_second	1
mysql/innodb_table_stats	1
mysql/innodb_index_stats	1
mysql/slave_relay_log_info	1
mysql/slave_master_info	1
mysql/slave_worker_info	1
mysql/gtid_executed	1
mysql/server_cost	1
mysql/engine_cost	1
sys/sys_config	1
test/t1	1
test/t2	1
ts_encrypted	1
test/t4	1
test/t6	1
innodb_system	1
SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLESPACES;
SPACE	NAME	FLAG	FILE_FORMAT	ROW_FORMAT	PAGE_SIZE	ZIP_PAGE_SIZE	SPACE_TYPE	FS_BLOCK_SIZE	FILE_SIZE	ALLOCATED_SIZE
2	mysql/plugin	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
3	mysql/servers	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
4	mysql/help_topic	8225	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
5	mysql/help_category	8225	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
6	mysql/help_relation	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
7	mysql/help_keyword	8225	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
8	mysql/time_zone_name	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
9	mysql/time_zone	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
10	mysql/time_zone_transition	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
11	mysql/time_zone_transition_type	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
12	mysql/time_zone_leap_second	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
13	mysql/innodb_table_stats	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
14	mysql/innodb_index_stats	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
15	mysql/slave_relay_log_info	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
16	mysql/slave_master_info	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
17	mysql/slave_worker_info	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
18	mysql/gtid_executed	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
19	mysql/server_cost	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
20	mysql/engine_cost	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
21	sys/sys_config	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
23	test/t1	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
24	test/t2	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
25	test/t3	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
27	ts_encrypted	10240	Any	Any	16384	0	General	4096	98304	98304
30	test/t4	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
32	test/t6	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLES;
TABLE_ID	NAME	FLAG	N_COLS	SPACE	FILE_FORMAT	ROW_FORMAT	ZIP_PAGE_SIZE	SPACE_TYPE
14	SYS_DATAFILES	0	5	0	Antelope	Redundant	0	System
11	SYS_FOREIGN	0	7	0	Antelope	Redundant	0	System
12	SYS_FOREIGN_COLS	0	7	0	Antelope	Redundant	0	System
13	SYS_TABLESPACES	0	6	0	Antelope	Redundant	0	System
15	SYS_VIRTUAL	0	6	0	Antelope	Redundant	0	System
16	SYS_ZIP_DICT	0	6	0	Antelope	Redundant	0	System
17	SYS_ZIP_DICT_COLS	0	6	0	Antelope	Redundant	0	System
36	mysql/engine_cost	33	9	20	Barracuda	Dynamic	0	Single
34	mysql/gtid_executed	33	6	18	Barracuda	Dynamic	0	Single
21	mysql/help_category	33	7	5	Barracuda	Dynamic	0	Single
23	mysql/help_keyword	33	5	7	Barracuda	Dynamic	0	Single
22	mysql/help_relation	33	5	6	Barracuda	Dynamic	0	Single
20	mysql/help_topic	33	9	4	Barracuda	Dynamic	0	Single
30	mysql/innodb_index_stats	33	11	14	Barracuda	Dynamic	0	Single
29	mysql/innodb_table_stats	33	9	13	Barracuda	Dynamic	0	Single
18	mysql/plugin	33	5	2	Barracuda	Dynamic	0	Single
35	mysql/server_cost	33	7	19	Barracuda	Dynamic	0	Single
19	mysql/servers	33	12	3	Barracuda	Dynamic	0	Single
32	mysql/slave_master_info	33	28	16	Barracuda	Dynamic	0	Single
31	mysql/slave_relay_log_info	33	12	15	Barracuda	Dynamic	0	Single
33	mysql/slave_worker_info	33	16	17	Barracuda	Dynamic	0	Single
25	mysql/time_zone	33	5	9	Barracuda	Dynamic	0	Single
28	mysql/time_zone_leap_second	33	5	12	Barracuda	Dynamic	0	Single
24	mysql/time_zone_name	33	5	8	Barracuda	Dynamic	0	Single
26	mysql/time_zone_transition	33	6	10	Barracuda	Dynamic	0	Single
27	mysql/time_zone_transition_type	33	8	11	Barracuda	Dynamic	0	Single
37	sys/sys_config	33	7	21	Barracuda	Dynamic	0	Single
38	test/t1	33	4	23	Barracuda	Dynamic	0	Single
39	test/t2	33	4	24	Barracuda	Dynamic	0	Single
40	test/t3	33	4	25	Barracuda	Dynamic	0	Single
45	test/t4	33	4	30	Barracuda	Dynamic	0	Single
42	test/t5	161	4	27	Barracuda	Dynamic	0	General
47	test/t6	33	4	32	Barracuda	Dynamic	0	Single
SHOW CREATE TABLE INFORMATION_SCHEMA.INNODB_SYS_TABLESPACES;
Table	Create Table
INNODB_SYS_TABLESPACES	CREATE TEMPORARY TABLE `INNODB_SYS_TABLESPACES` (
  `SPACE` int(11) unsigned NOT NULL DEFAULT '0',
  `NAME` varchar(655) NOT NULL DEFAULT '',
  `FLAG` int(11) unsigned NOT NULL DEFAULT '0',
  `FILE_FORMAT` varchar(10) DEFAULT NULL,
  `ROW_FORMAT` varchar(22) DEFAULT NULL,
  `PAGE_SIZE` int(11) unsigned NOT NULL DEFAULT '0',
  `ZIP_PAGE_SIZE` int(11) unsigned NOT NULL DEFAULT '0',
  `SPACE_TYPE` varchar(10) DEFAULT NULL,
  `FS_BLOCK_SIZE` int(11) unsigned NOT NULL DEFAULT '0',
  `FILE_SIZE` bigint(21) unsigned NOT NULL DEFAULT '0',
  `ALLOCATED_SIZE` bigint(21) unsigned NOT NULL DEFAULT '0'
) ENGINE=MEMORY DEFAULT CHARSET=utf8
SHOW CREATE TABLE INFORMATION_SCHEMA.INNODB_SYS_TABLES;
Table	Create Table
INNODB_SYS_TABLES	CREATE TEMPORARY TABLE `INNODB_SYS_TABLES` (
  `TABLE_ID` bigint(21) unsigned NOT NULL DEFAULT '0',
  `NAME` varchar(655) NOT NULL DEFAULT '',
  `FLAG` int(11) NOT NULL DEFAULT '0',
  `N_COLS` int(11) NOT NULL DEFAULT '0',
  `SPACE` int(11) NOT NULL DEFAULT '0',
  `FILE_FORMAT` varchar(10) DEFAULT NULL,
  `ROW_FORMAT` varchar(12) DEFAULT NULL,
  `ZIP_PAGE_SIZE` int(11) unsigned NOT NULL DEFAULT '0',
  `SPACE_TYPE` varchar(10) DEFAULT NULL
) ENGINE=MEMORY DEFAULT CHARSET=utf8
# t1 yes on expecting NOT FOUND
# t2 ... on expecting NOT FOUND
# t3 no  on expecting FOUND
# t4 no  on expecting NOT FOUND
# ibdata1 expecting NOT FOUND
# ts_encrypted expecting NOT FOUND
# restart:--early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=/home/rob/git/5.7_rotated_tablespaces_bld/mysql-test/var/tmp/mysecret_keyring --plugin-dir=/home/rob/git/5.7_rotated_tablespaces_bld/plugin/keyring --innodb-encrypt-tables=ONLINE_TO_KEYRING --innodb-encryption-rotate-key-age=15 --innodb-encryption-threads=1
# Now turn off encryption and wait for threads to decrypt everything
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 0;
NAME	MIN_KEY_VERSION
test/t3	0
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;
NAME	MIN_KEY_VERSION
mysql/plugin	1
mysql/servers	1
mysql/help_topic	1
mysql/help_category	1
mysql/help_relation	1
mysql/help_keyword	1
mysql/time_zone_name	1
mysql/time_zone	1
mysql/time_zone_transition	1
mysql/time_zone_transition_type	1
mysql/time_zone_leap_second	1
mysql/innodb_table_stats	1
mysql/innodb_index_stats	1
mysql/slave_relay_log_info	1
mysql/slave_master_info	1
mysql/slave_worker_info	1
mysql/gtid_executed	1
mysql/server_cost	1
mysql/engine_cost	1
sys/sys_config	1
test/t1	1
test/t2	1
ts_encrypted	1
test/t4	1
test/t6	1
innodb_system	1
SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLESPACES;
SPACE	NAME	FLAG	FILE_FORMAT	ROW_FORMAT	PAGE_SIZE	ZIP_PAGE_SIZE	SPACE_TYPE	FS_BLOCK_SIZE	FILE_SIZE	ALLOCATED_SIZE
2	mysql/plugin	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
3	mysql/servers	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
4	mysql/help_topic	8225	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
5	mysql/help_category	8225	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
6	mysql/help_relation	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
7	mysql/help_keyword	8225	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
8	mysql/time_zone_name	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
9	mysql/time_zone	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
10	mysql/time_zone_transition	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
11	mysql/time_zone_transition_type	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
12	mysql/time_zone_leap_second	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
13	mysql/innodb_table_stats	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
14	mysql/innodb_index_stats	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
15	mysql/slave_relay_log_info	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
16	mysql/slave_master_info	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
17	mysql/slave_worker_info	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
18	mysql/gtid_executed	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
19	mysql/server_cost	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
20	mysql/engine_cost	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
21	sys/sys_config	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
23	test/t1	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
24	test/t2	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
25	test/t3	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
27	ts_encrypted	10240	Any	Any	16384	0	General	4096	98304	98304
30	test/t4	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
32	test/t6	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLES;
TABLE_ID	NAME	FLAG	N_COLS	SPACE	FILE_FORMAT	ROW_FORMAT	ZIP_PAGE_SIZE	SPACE_TYPE
14	SYS_DATAFILES	0	5	0	Antelope	Redundant	0	System
11	SYS_FOREIGN	0	7	0	Antelope	Redundant	0	System
12	SYS_FOREIGN_COLS	0	7	0	Antelope	Redundant	0	System
13	SYS_TABLESPACES	0	6	0	Antelope	Redundant	0	System
15	SYS_VIRTUAL	0	6	0	Antelope	Redundant	0	System
16	SYS_ZIP_DICT	0	6	0	Antelope	Redundant	0	System
17	SYS_ZIP_DICT_COLS	0	6	0	Antelope	Redundant	0	System
36	mysql/engine_cost	33	9	20	Barracuda	Dynamic	0	Single
34	mysql/gtid_executed	33	6	18	Barracuda	Dynamic	0	Single
21	mysql/help_category	33	7	5	Barracuda	Dynamic	0	Single
23	mysql/help_keyword	33	5	7	Barracuda	Dynamic	0	Single
22	mysql/help_relation	33	5	6	Barracuda	Dynamic	0	Single
20	mysql/help_topic	33	9	4	Barracuda	Dynamic	0	Single
30	mysql/innodb_index_stats	33	11	14	Barracuda	Dynamic	0	Single
29	mysql/innodb_table_stats	33	9	13	Barracuda	Dynamic	0	Single
18	mysql/plugin	33	5	2	Barracuda	Dynamic	0	Single
35	mysql/server_cost	33	7	19	Barracuda	Dynamic	0	Single
19	mysql/servers	33	12	3	Barracuda	Dynamic	0	Single
32	mysql/slave_master_info	33	28	16	Barracuda	Dynamic	0	Single
31	mysql/slave_relay_log_info	33	12	15	Barracuda	Dynamic	0	Single
33	mysql/slave_worker_info	33	16	17	Barracuda	Dynamic	0	Single
25	mysql/time_zone	33	5	9	Barracuda	Dynamic	0	Single
28	mysql/time_zone_leap_second	33	5	12	Barracuda	Dynamic	0	Single
24	mysql/time_zone_name	33	5	8	Barracuda	Dynamic	0	Single
26	mysql/time_zone_transition	33	6	10	Barracuda	Dynamic	0	Single
27	mysql/time_zone_transition_type	33	8	11	Barracuda	Dynamic	0	Single
37	sys/sys_config	33	7	21	Barracuda	Dynamic	0	Single
38	test/t1	33	4	23	Barracuda	Dynamic	0	Single
39	test/t2	33	4	24	Barracuda	Dynamic	0	Single
40	test/t3	33	4	25	Barracuda	Dynamic	0	Single
45	test/t4	33	4	30	Barracuda	Dynamic	0	Single
42	test/t5	161	4	27	Barracuda	Dynamic	0	General
47	test/t6	33	4	32	Barracuda	Dynamic	0	Single
SET GLOBAL innodb_encrypt_tables = ONLINE_FROM_KEYRING_TO_UNENCRYPTED;
# Only three tables should stayed encrypted - the ones with explicite encryption
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 0;
NAME	MIN_KEY_VERSION
mysql/plugin	0
mysql/servers	0
mysql/help_topic	0
mysql/help_category	0
mysql/help_relation	0
mysql/help_keyword	0
mysql/time_zone_name	0
mysql/time_zone	0
mysql/time_zone_transition	0
mysql/time_zone_transition_type	0
mysql/time_zone_leap_second	0
mysql/innodb_table_stats	0
mysql/innodb_index_stats	0
mysql/slave_relay_log_info	0
mysql/slave_master_info	0
mysql/slave_worker_info	0
mysql/gtid_executed	0
mysql/server_cost	0
mysql/engine_cost	0
sys/sys_config	0
test/t2	0
test/t3	0
ts_encrypted	0
innodb_system	0
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;
NAME	MIN_KEY_VERSION
test/t1	1
test/t4	1
test/t6	1
SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLESPACES;
SPACE	NAME	FLAG	FILE_FORMAT	ROW_FORMAT	PAGE_SIZE	ZIP_PAGE_SIZE	SPACE_TYPE	FS_BLOCK_SIZE	FILE_SIZE	ALLOCATED_SIZE
2	mysql/plugin	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
3	mysql/servers	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
4	mysql/help_topic	33	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
5	mysql/help_category	33	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
6	mysql/help_relation	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
7	mysql/help_keyword	33	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
8	mysql/time_zone_name	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
9	mysql/time_zone	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
10	mysql/time_zone_transition	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
11	mysql/time_zone_transition_type	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
12	mysql/time_zone_leap_second	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
13	mysql/innodb_table_stats	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
14	mysql/innodb_index_stats	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
15	mysql/slave_relay_log_info	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
16	mysql/slave_master_info	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
17	mysql/slave_worker_info	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
18	mysql/gtid_executed	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
19	mysql/server_cost	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
20	mysql/engine_cost	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
21	sys/sys_config	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
23	test/t1	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
24	test/t2	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
25	test/t3	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
27	ts_encrypted	2048	Any	Any	16384	0	General	4096	98304	98304
30	test/t4	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
32	test/t6	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLES;
TABLE_ID	NAME	FLAG	N_COLS	SPACE	FILE_FORMAT	ROW_FORMAT	ZIP_PAGE_SIZE	SPACE_TYPE
14	SYS_DATAFILES	0	5	0	Antelope	Redundant	0	System
11	SYS_FOREIGN	0	7	0	Antelope	Redundant	0	System
12	SYS_FOREIGN_COLS	0	7	0	Antelope	Redundant	0	System
13	SYS_TABLESPACES	0	6	0	Antelope	Redundant	0	System
15	SYS_VIRTUAL	0	6	0	Antelope	Redundant	0	System
16	SYS_ZIP_DICT	0	6	0	Antelope	Redundant	0	System
17	SYS_ZIP_DICT_COLS	0	6	0	Antelope	Redundant	0	System
36	mysql/engine_cost	33	9	20	Barracuda	Dynamic	0	Single
34	mysql/gtid_executed	33	6	18	Barracuda	Dynamic	0	Single
21	mysql/help_category	33	7	5	Barracuda	Dynamic	0	Single
23	mysql/help_keyword	33	5	7	Barracuda	Dynamic	0	Single
22	mysql/help_relation	33	5	6	Barracuda	Dynamic	0	Single
20	mysql/help_topic	33	9	4	Barracuda	Dynamic	0	Single
30	mysql/innodb_index_stats	33	11	14	Barracuda	Dynamic	0	Single
29	mysql/innodb_table_stats	33	9	13	Barracuda	Dynamic	0	Single
18	mysql/plugin	33	5	2	Barracuda	Dynamic	0	Single
35	mysql/server_cost	33	7	19	Barracuda	Dynamic	0	Single
19	mysql/servers	33	12	3	Barracuda	Dynamic	0	Single
32	mysql/slave_master_info	33	28	16	Barracuda	Dynamic	0	Single
31	mysql/slave_relay_log_info	33	12	15	Barracuda	Dynamic	0	Single
33	mysql/slave_worker_info	33	16	17	Barracuda	Dynamic	0	Single
25	mysql/time_zone	33	5	9	Barracuda	Dynamic	0	Single
28	mysql/time_zone_leap_second	33	5	12	Barracuda	Dynamic	0	Single
24	mysql/time_zone_name	33	5	8	Barracuda	Dynamic	0	Single
26	mysql/time_zone_transition	33	6	10	Barracuda	Dynamic	0	Single
27	mysql/time_zone_transition_type	33	8	11	Barracuda	Dynamic	0	Single
37	sys/sys_config	33	7	21	Barracuda	Dynamic	0	Single
38	test/t1	33	4	23	Barracuda	Dynamic	0	Single
39	test/t2	33	4	24	Barracuda	Dynamic	0	Single
40	test/t3	33	4	25	Barracuda	Dynamic	0	Single
45	test/t4	33	4	30	Barracuda	Dynamic	0	Single
42	test/t5	161	4	27	Barracuda	Dynamic	0	General
47	test/t6	33	4	32	Barracuda	Dynamic	0	Single
include/assert.inc [Only two tables should stayed encrypted - the ones with explicite encryption t1 and t4]
SELECT NAME, MIN_KEY_VERSION, ROTATING_OR_FLUSHING FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 0;
NAME	MIN_KEY_VERSION	ROTATING_OR_FLUSHING
mysql/plugin	0	0
mysql/servers	0	0
mysql/help_topic	0	0
mysql/help_category	0	0
mysql/help_relation	0	0
mysql/help_keyword	0	0
mysql/time_zone_name	0	0
mysql/time_zone	0	0
mysql/time_zone_transition	0	0
mysql/time_zone_transition_type	0	0
mysql/time_zone_leap_second	0	0
mysql/innodb_table_stats	0	0
mysql/innodb_index_stats	0	0
mysql/slave_relay_log_info	0	0
mysql/slave_master_info	0	0
mysql/slave_worker_info	0	0
mysql/gtid_executed	0	0
mysql/server_cost	0	0
mysql/engine_cost	0	0
sys/sys_config	0	0
test/t2	0	0
test/t3	0	0
ts_encrypted	0	0
innodb_system	0	0
SELECT NAME, MIN_KEY_VERSION, ROTATING_OR_FLUSHING FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;
NAME	MIN_KEY_VERSION	ROTATING_OR_FLUSHING
test/t1	1	0
test/t4	1	0
test/t6	1	0
SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLESPACES;
SPACE	NAME	FLAG	FILE_FORMAT	ROW_FORMAT	PAGE_SIZE	ZIP_PAGE_SIZE	SPACE_TYPE	FS_BLOCK_SIZE	FILE_SIZE	ALLOCATED_SIZE
2	mysql/plugin	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
3	mysql/servers	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
4	mysql/help_topic	33	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
5	mysql/help_category	33	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
6	mysql/help_relation	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
7	mysql/help_keyword	33	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
8	mysql/time_zone_name	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
9	mysql/time_zone	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
10	mysql/time_zone_transition	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
11	mysql/time_zone_transition_type	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
12	mysql/time_zone_leap_second	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
13	mysql/innodb_table_stats	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
14	mysql/innodb_index_stats	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
15	mysql/slave_relay_log_info	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
16	mysql/slave_master_info	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
17	mysql/slave_worker_info	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
18	mysql/gtid_executed	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
19	mysql/server_cost	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
20	mysql/engine_cost	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
21	sys/sys_config	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
23	test/t1	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
24	test/t2	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
25	test/t3	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
27	ts_encrypted	2048	Any	Any	16384	0	General	4096	98304	98304
30	test/t4	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
32	test/t6	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLES;
TABLE_ID	NAME	FLAG	N_COLS	SPACE	FILE_FORMAT	ROW_FORMAT	ZIP_PAGE_SIZE	SPACE_TYPE
14	SYS_DATAFILES	0	5	0	Antelope	Redundant	0	System
11	SYS_FOREIGN	0	7	0	Antelope	Redundant	0	System
12	SYS_FOREIGN_COLS	0	7	0	Antelope	Redundant	0	System
13	SYS_TABLESPACES	0	6	0	Antelope	Redundant	0	System
15	SYS_VIRTUAL	0	6	0	Antelope	Redundant	0	System
16	SYS_ZIP_DICT	0	6	0	Antelope	Redundant	0	System
17	SYS_ZIP_DICT_COLS	0	6	0	Antelope	Redundant	0	System
36	mysql/engine_cost	33	9	20	Barracuda	Dynamic	0	Single
34	mysql/gtid_executed	33	6	18	Barracuda	Dynamic	0	Single
21	mysql/help_category	33	7	5	Barracuda	Dynamic	0	Single
23	mysql/help_keyword	33	5	7	Barracuda	Dynamic	0	Single
22	mysql/help_relation	33	5	6	Barracuda	Dynamic	0	Single
20	mysql/help_topic	33	9	4	Barracuda	Dynamic	0	Single
30	mysql/innodb_index_stats	33	11	14	Barracuda	Dynamic	0	Single
29	mysql/innodb_table_stats	33	9	13	Barracuda	Dynamic	0	Single
18	mysql/plugin	33	5	2	Barracuda	Dynamic	0	Single
35	mysql/server_cost	33	7	19	Barracuda	Dynamic	0	Single
19	mysql/servers	33	12	3	Barracuda	Dynamic	0	Single
32	mysql/slave_master_info	33	28	16	Barracuda	Dynamic	0	Single
31	mysql/slave_relay_log_info	33	12	15	Barracuda	Dynamic	0	Single
33	mysql/slave_worker_info	33	16	17	Barracuda	Dynamic	0	Single
25	mysql/time_zone	33	5	9	Barracuda	Dynamic	0	Single
28	mysql/time_zone_leap_second	33	5	12	Barracuda	Dynamic	0	Single
24	mysql/time_zone_name	33	5	8	Barracuda	Dynamic	0	Single
26	mysql/time_zone_transition	33	6	10	Barracuda	Dynamic	0	Single
27	mysql/time_zone_transition_type	33	8	11	Barracuda	Dynamic	0	Single
37	sys/sys_config	33	7	21	Barracuda	Dynamic	0	Single
38	test/t1	33	4	23	Barracuda	Dynamic	0	Single
39	test/t2	33	4	24	Barracuda	Dynamic	0	Single
40	test/t3	33	4	25	Barracuda	Dynamic	0	Single
45	test/t4	33	4	30	Barracuda	Dynamic	0	Single
42	test/t5	161	4	27	Barracuda	Dynamic	0	General
47	test/t6	33	4	32	Barracuda	Dynamic	0	Single
# t1 yes on expecting NOT FOUND
# t2 ... default expecting FOUND
# t3 no  on expecting FOUND
# t1 yes on expecting NOT FOUND
# ibdata1 expecting NOT FOUND
# restart:--early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=/home/rob/git/5.7_rotated_tablespaces_bld/mysql-test/var/tmp/mysecret_keyring --plugin-dir=/home/rob/git/5.7_rotated_tablespaces_bld/plugin/keyring --innodb-encrypt-tables=ONLINE_TO_KEYRING --innodb-encryption-rotate-key-age=15 --innodb-encryption-threads=4
# Now turn on encryption and wait for threads to encrypt all spaces
SET GLOBAL innodb_encrypt_tables = ONLINE_TO_KEYRING;
# Wait max 10 min for key encryption threads to encrypt all spaces
include/assert.inc [Only one table should stay unencrypted i.e. t3]
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 0;
NAME	MIN_KEY_VERSION
test/t3	0
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;
NAME	MIN_KEY_VERSION
mysql/plugin	1
mysql/servers	1
mysql/help_topic	1
mysql/help_category	1
mysql/help_relation	1
mysql/help_keyword	1
mysql/time_zone_name	1
mysql/time_zone	1
mysql/time_zone_transition	1
mysql/time_zone_transition_type	1
mysql/time_zone_leap_second	1
mysql/innodb_table_stats	1
mysql/innodb_index_stats	1
mysql/slave_relay_log_info	1
mysql/slave_master_info	1
mysql/slave_worker_info	1
mysql/gtid_executed	1
mysql/server_cost	1
mysql/engine_cost	1
sys/sys_config	1
test/t1	1
test/t2	1
ts_encrypted	1
test/t4	1
test/t6	1
innodb_system	1
SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLESPACES;
SPACE	NAME	FLAG	FILE_FORMAT	ROW_FORMAT	PAGE_SIZE	ZIP_PAGE_SIZE	SPACE_TYPE	FS_BLOCK_SIZE	FILE_SIZE	ALLOCATED_SIZE
2	mysql/plugin	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
3	mysql/servers	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
4	mysql/help_topic	8225	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
5	mysql/help_category	8225	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
6	mysql/help_relation	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
7	mysql/help_keyword	8225	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
8	mysql/time_zone_name	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
9	mysql/time_zone	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
10	mysql/time_zone_transition	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
11	mysql/time_zone_transition_type	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
12	mysql/time_zone_leap_second	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
13	mysql/innodb_table_stats	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
14	mysql/innodb_index_stats	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
15	mysql/slave_relay_log_info	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
16	mysql/slave_master_info	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
17	mysql/slave_worker_info	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
18	mysql/gtid_executed	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
19	mysql/server_cost	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
20	mysql/engine_cost	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
21	sys/sys_config	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
23	test/t1	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
24	test/t2	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
25	test/t3	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
27	ts_encrypted	10240	Any	Any	16384	0	General	4096	98304	98304
30	test/t4	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
32	test/t6	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLES;
TABLE_ID	NAME	FLAG	N_COLS	SPACE	FILE_FORMAT	ROW_FORMAT	ZIP_PAGE_SIZE	SPACE_TYPE
14	SYS_DATAFILES	0	5	0	Antelope	Redundant	0	System
11	SYS_FOREIGN	0	7	0	Antelope	Redundant	0	System
12	SYS_FOREIGN_COLS	0	7	0	Antelope	Redundant	0	System
13	SYS_TABLESPACES	0	6	0	Antelope	Redundant	0	System
15	SYS_VIRTUAL	0	6	0	Antelope	Redundant	0	System
16	SYS_ZIP_DICT	0	6	0	Antelope	Redundant	0	System
17	SYS_ZIP_DICT_COLS	0	6	0	Antelope	Redundant	0	System
36	mysql/engine_cost	33	9	20	Barracuda	Dynamic	0	Single
34	mysql/gtid_executed	33	6	18	Barracuda	Dynamic	0	Single
21	mysql/help_category	33	7	5	Barracuda	Dynamic	0	Single
23	mysql/help_keyword	33	5	7	Barracuda	Dynamic	0	Single
22	mysql/help_relation	33	5	6	Barracuda	Dynamic	0	Single
20	mysql/help_topic	33	9	4	Barracuda	Dynamic	0	Single
30	mysql/innodb_index_stats	33	11	14	Barracuda	Dynamic	0	Single
29	mysql/innodb_table_stats	33	9	13	Barracuda	Dynamic	0	Single
18	mysql/plugin	33	5	2	Barracuda	Dynamic	0	Single
35	mysql/server_cost	33	7	19	Barracuda	Dynamic	0	Single
19	mysql/servers	33	12	3	Barracuda	Dynamic	0	Single
32	mysql/slave_master_info	33	28	16	Barracuda	Dynamic	0	Single
31	mysql/slave_relay_log_info	33	12	15	Barracuda	Dynamic	0	Single
33	mysql/slave_worker_info	33	16	17	Barracuda	Dynamic	0	Single
25	mysql/time_zone	33	5	9	Barracuda	Dynamic	0	Single
28	mysql/time_zone_leap_second	33	5	12	Barracuda	Dynamic	0	Single
24	mysql/time_zone_name	33	5	8	Barracuda	Dynamic	0	Single
26	mysql/time_zone_transition	33	6	10	Barracuda	Dynamic	0	Single
27	mysql/time_zone_transition_type	33	8	11	Barracuda	Dynamic	0	Single
37	sys/sys_config	33	7	21	Barracuda	Dynamic	0	Single
38	test/t1	33	4	23	Barracuda	Dynamic	0	Single
39	test/t2	33	4	24	Barracuda	Dynamic	0	Single
40	test/t3	33	4	25	Barracuda	Dynamic	0	Single
45	test/t4	33	4	30	Barracuda	Dynamic	0	Single
42	test/t5	161	4	27	Barracuda	Dynamic	0	General
47	test/t6	33	4	32	Barracuda	Dynamic	0	Single
# t1 yes on expecting NOT FOUND
# t2 ... on expecting NOT FOUND
# t3 no  on expecting FOUND
# t1 yes on expecting NOT FOUND
# ibdata1 expecting NOT FOUND
# restart:--early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=/home/rob/git/5.7_rotated_tablespaces_bld/mysql-test/var/tmp/mysecret_keyring --plugin-dir=/home/rob/git/5.7_rotated_tablespaces_bld/plugin/keyring --innodb-encrypt-tables=ONLINE_TO_KEYRING --innodb-encryption-rotate-key-age=15 --innodb-encryption-threads=4
alter table t1 encryption='n';
alter table t4 encryption='n';
# Wait max 10 min for key encryption threads to encrypt all spaces (apart from t1,t3 and t4)
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 0;
NAME	MIN_KEY_VERSION
test/t3	0
test/t1	0
test/t4	0
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;
NAME	MIN_KEY_VERSION
mysql/plugin	1
mysql/servers	1
mysql/help_topic	1
mysql/help_category	1
mysql/help_relation	1
mysql/help_keyword	1
mysql/time_zone_name	1
mysql/time_zone	1
mysql/time_zone_transition	1
mysql/time_zone_transition_type	1
mysql/time_zone_leap_second	1
mysql/innodb_table_stats	1
mysql/innodb_index_stats	1
mysql/slave_relay_log_info	1
mysql/slave_master_info	1
mysql/slave_worker_info	1
mysql/gtid_executed	1
mysql/server_cost	1
mysql/engine_cost	1
sys/sys_config	1
test/t2	1
ts_encrypted	1
test/t6	1
innodb_system	1
SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLESPACES;
SPACE	NAME	FLAG	FILE_FORMAT	ROW_FORMAT	PAGE_SIZE	ZIP_PAGE_SIZE	SPACE_TYPE	FS_BLOCK_SIZE	FILE_SIZE	ALLOCATED_SIZE
2	mysql/plugin	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
3	mysql/servers	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
4	mysql/help_topic	8225	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
5	mysql/help_category	8225	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
6	mysql/help_relation	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
7	mysql/help_keyword	8225	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
8	mysql/time_zone_name	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
9	mysql/time_zone	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
10	mysql/time_zone_transition	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
11	mysql/time_zone_transition_type	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
12	mysql/time_zone_leap_second	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
13	mysql/innodb_table_stats	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
14	mysql/innodb_index_stats	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
15	mysql/slave_relay_log_info	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
16	mysql/slave_master_info	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
17	mysql/slave_worker_info	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
18	mysql/gtid_executed	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
19	mysql/server_cost	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
20	mysql/engine_cost	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
21	sys/sys_config	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
24	test/t2	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
25	test/t3	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
27	ts_encrypted	10240	Any	Any	16384	0	General	4096	98304	98304
32	test/t6	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
36	test/t1	33	Barracuda	Dynamic	16384	0	Single	4096	98304	65536
37	test/t4	33	Barracuda	Dynamic	16384	0	Single	4096	98304	65536
SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLES;
TABLE_ID	NAME	FLAG	N_COLS	SPACE	FILE_FORMAT	ROW_FORMAT	ZIP_PAGE_SIZE	SPACE_TYPE
14	SYS_DATAFILES	0	5	0	Antelope	Redundant	0	System
11	SYS_FOREIGN	0	7	0	Antelope	Redundant	0	System
12	SYS_FOREIGN_COLS	0	7	0	Antelope	Redundant	0	System
13	SYS_TABLESPACES	0	6	0	Antelope	Redundant	0	System
15	SYS_VIRTUAL	0	6	0	Antelope	Redundant	0	System
16	SYS_ZIP_DICT	0	6	0	Antelope	Redundant	0	System
17	SYS_ZIP_DICT_COLS	0	6	0	Antelope	Redundant	0	System
36	mysql/engine_cost	33	9	20	Barracuda	Dynamic	0	Single
34	mysql/gtid_executed	33	6	18	Barracuda	Dynamic	0	Single
21	mysql/help_category	33	7	5	Barracuda	Dynamic	0	Single
23	mysql/help_keyword	33	5	7	Barracuda	Dynamic	0	Single
22	mysql/help_relation	33	5	6	Barracuda	Dynamic	0	Single
20	mysql/help_topic	33	9	4	Barracuda	Dynamic	0	Single
30	mysql/innodb_index_stats	33	11	14	Barracuda	Dynamic	0	Single
29	mysql/innodb_table_stats	33	9	13	Barracuda	Dynamic	0	Single
18	mysql/plugin	33	5	2	Barracuda	Dynamic	0	Single
35	mysql/server_cost	33	7	19	Barracuda	Dynamic	0	Single
19	mysql/servers	33	12	3	Barracuda	Dynamic	0	Single
32	mysql/slave_master_info	33	28	16	Barracuda	Dynamic	0	Single
31	mysql/slave_relay_log_info	33	12	15	Barracuda	Dynamic	0	Single
33	mysql/slave_worker_info	33	16	17	Barracuda	Dynamic	0	Single
25	mysql/time_zone	33	5	9	Barracuda	Dynamic	0	Single
28	mysql/time_zone_leap_second	33	5	12	Barracuda	Dynamic	0	Single
24	mysql/time_zone_name	33	5	8	Barracuda	Dynamic	0	Single
26	mysql/time_zone_transition	33	6	10	Barracuda	Dynamic	0	Single
27	mysql/time_zone_transition_type	33	8	11	Barracuda	Dynamic	0	Single
37	sys/sys_config	33	7	21	Barracuda	Dynamic	0	Single
48	test/t1	33	4	36	Barracuda	Dynamic	0	Single
39	test/t2	33	4	24	Barracuda	Dynamic	0	Single
40	test/t3	33	4	25	Barracuda	Dynamic	0	Single
49	test/t4	33	4	37	Barracuda	Dynamic	0	Single
42	test/t5	161	4	27	Barracuda	Dynamic	0	General
47	test/t6	33	4	32	Barracuda	Dynamic	0	Single
include/assert.inc [All spaces apart from t1, t3 and t4 should got encrypted]
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 0;
NAME	MIN_KEY_VERSION
test/t3	0
test/t1	0
test/t4	0
SELECT NAME, MIN_KEY_VERSION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;
NAME	MIN_KEY_VERSION
mysql/plugin	1
mysql/servers	1
mysql/help_topic	1
mysql/help_category	1
mysql/help_relation	1
mysql/help_keyword	1
mysql/time_zone_name	1
mysql/time_zone	1
mysql/time_zone_transition	1
mysql/time_zone_transition_type	1
mysql/time_zone_leap_second	1
mysql/innodb_table_stats	1
mysql/innodb_index_stats	1
mysql/slave_relay_log_info	1
mysql/slave_master_info	1
mysql/slave_worker_info	1
mysql/gtid_executed	1
mysql/server_cost	1
mysql/engine_cost	1
sys/sys_config	1
test/t2	1
ts_encrypted	1
test/t6	1
innodb_system	1
SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLESPACES;
SPACE	NAME	FLAG	FILE_FORMAT	ROW_FORMAT	PAGE_SIZE	ZIP_PAGE_SIZE	SPACE_TYPE	FS_BLOCK_SIZE	FILE_SIZE	ALLOCATED_SIZE
2	mysql/plugin	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
3	mysql/servers	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
4	mysql/help_topic	8225	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
5	mysql/help_category	8225	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
6	mysql/help_relation	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
7	mysql/help_keyword	8225	Barracuda	Dynamic	16384	0	Single	4096	114688	114688
8	mysql/time_zone_name	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
9	mysql/time_zone	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
10	mysql/time_zone_transition	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
11	mysql/time_zone_transition_type	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
12	mysql/time_zone_leap_second	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
13	mysql/innodb_table_stats	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
14	mysql/innodb_index_stats	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
15	mysql/slave_relay_log_info	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
16	mysql/slave_master_info	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
17	mysql/slave_worker_info	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
18	mysql/gtid_executed	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
19	mysql/server_cost	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
20	mysql/engine_cost	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
21	sys/sys_config	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
24	test/t2	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
25	test/t3	33	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
27	ts_encrypted	10240	Any	Any	16384	0	General	4096	98304	98304
32	test/t6	8225	Barracuda	Dynamic	16384	0	Single	4096	98304	98304
36	test/t1	33	Barracuda	Dynamic	16384	0	Single	4096	98304	65536
37	test/t4	33	Barracuda	Dynamic	16384	0	Single	4096	98304	65536
SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLES;
TABLE_ID	NAME	FLAG	N_COLS	SPACE	FILE_FORMAT	ROW_FORMAT	ZIP_PAGE_SIZE	SPACE_TYPE
14	SYS_DATAFILES	0	5	0	Antelope	Redundant	0	System
11	SYS_FOREIGN	0	7	0	Antelope	Redundant	0	System
12	SYS_FOREIGN_COLS	0	7	0	Antelope	Redundant	0	System
13	SYS_TABLESPACES	0	6	0	Antelope	Redundant	0	System
15	SYS_VIRTUAL	0	6	0	Antelope	Redundant	0	System
16	SYS_ZIP_DICT	0	6	0	Antelope	Redundant	0	System
17	SYS_ZIP_DICT_COLS	0	6	0	Antelope	Redundant	0	System
36	mysql/engine_cost	33	9	20	Barracuda	Dynamic	0	Single
34	mysql/gtid_executed	33	6	18	Barracuda	Dynamic	0	Single
21	mysql/help_category	33	7	5	Barracuda	Dynamic	0	Single
23	mysql/help_keyword	33	5	7	Barracuda	Dynamic	0	Single
22	mysql/help_relation	33	5	6	Barracuda	Dynamic	0	Single
20	mysql/help_topic	33	9	4	Barracuda	Dynamic	0	Single
30	mysql/innodb_index_stats	33	11	14	Barracuda	Dynamic	0	Single
29	mysql/innodb_table_stats	33	9	13	Barracuda	Dynamic	0	Single
18	mysql/plugin	33	5	2	Barracuda	Dynamic	0	Single
35	mysql/server_cost	33	7	19	Barracuda	Dynamic	0	Single
19	mysql/servers	33	12	3	Barracuda	Dynamic	0	Single
32	mysql/slave_master_info	33	28	16	Barracuda	Dynamic	0	Single
31	mysql/slave_relay_log_info	33	12	15	Barracuda	Dynamic	0	Single
33	mysql/slave_worker_info	33	16	17	Barracuda	Dynamic	0	Single
25	mysql/time_zone	33	5	9	Barracuda	Dynamic	0	Single
28	mysql/time_zone_leap_second	33	5	12	Barracuda	Dynamic	0	Single
24	mysql/time_zone_name	33	5	8	Barracuda	Dynamic	0	Single
26	mysql/time_zone_transition	33	6	10	Barracuda	Dynamic	0	Single
27	mysql/time_zone_transition_type	33	8	11	Barracuda	Dynamic	0	Single
37	sys/sys_config	33	7	21	Barracuda	Dynamic	0	Single
48	test/t1	33	4	36	Barracuda	Dynamic	0	Single
39	test/t2	33	4	24	Barracuda	Dynamic	0	Single
40	test/t3	33	4	25	Barracuda	Dynamic	0	Single
49	test/t4	33	4	37	Barracuda	Dynamic	0	Single
42	test/t5	161	4	27	Barracuda	Dynamic	0	General
47	test/t6	33	4	32	Barracuda	Dynamic	0	Single
# t1 yes on expecting FOUND
# t2 ... on expecting NOT FOUND
# t3 no  on expecting FOUND
# t4 no  on expecting FOUND
# ibdata1 expecting NOT FOUND
# restart:--early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=/home/rob/git/5.7_rotated_tablespaces_bld/mysql-test/var/tmp/mysecret_keyring --plugin-dir=/home/rob/git/5.7_rotated_tablespaces_bld/plugin/keyring --innodb-encrypt-tables=ONLINE_TO_KEYRING --innodb-encryption-rotate-key-age=15 --innodb-encryption-threads=4
drop table t1, t2, t3, t4, t5, t6;
drop tablespace ts_encrypted;
