call mtr.add_suppression("\\[InnoDB\\] Encryption can't generate tablespace key");
call mtr.add_suppression("\\[Server\\] Plugin keyring_file reported: 'File .*keyring' not found .*");
call mtr.add_suppression("keyring_file initialization failure. Please check if the keyring_file_data points to readable keyring file or keyring file can be created in the specified location. The keyring_file will stay unusable until correct path to the keyring file gets provided");
call mtr.add_suppression("\\[Server\\] Plugin 'keyring_file' init function returned error\.");
call mtr.add_suppression("\\[InnoDB\\] Tablespace id . in file t_keyring\.ibd is encrypted but keyring or used key_id 0 is not available\.");
# Wait max 10 min for key encryption threads to encrypt all spaces
# Encryption threads turned on, try uninstalling keyring
UNINSTALL PLUGIN keyring_file;
ERROR HY000: Plugin 'keyring_file' cannot be uninstalled now. Plugin is busy, it cannot be uninstalled. 
# Turn off encryption threads, uninstall keyring
SET GLOBAL innodb_encryption_threads=0;
UNINSTALL PLUGIN keyring_file;
# Turn on encryption back - should not be possible as there is keyring plugin installed
SET GLOBAL innodb_encryption_threads=1;
ERROR HY000: InnoDB: cannot enable encryption threads, keyring plugin is not available
# Install keyring plugin and turn encryption threads back on
INSTALL PLUGIN keyring_file SONAME 'keyring_file.so';
SET GLOBAL innodb_encryption_threads=4;
CREATE TABLE t_keyring (a varchar(255)) encryption='KEYRING';
CREATE table t_mk (a varchar(255)) engine=innodb;
# Turn off encryption threads, uninstall keyring. Check CREATE, ALTER etc.
SET GLOBAL innodb_encryption_threads=0;
SET GLOBAL default_table_encryption=ONLINE_FROM_KEYRING_TO_UNENCRYPTED;
UNINSTALL PLUGIN keyring_file;
CREATE TABLE t1 (a varchar(255)) engine=innodb encryption='KEYRING';
ERROR HY000: Seems that keyring is down. It is not possible to create encrypted tables  without keyring. Please install a keyring and try again.
CREATE TABLE t2 (a varchar(255)) engine=innodb;
ALTER TABLE t2 ENCRYPTION='KEYRING';
ERROR HY000: Seems that keyring is down. It is not possible to encrypt table without keyring. Please install a keyring and try again.
ALTER TABLE t_mk ENCRYPTION='KEYRING';
ERROR HY000: Seems that keyring is down. It is not possible to encrypt table without keyring. Please install a keyring and try again.
# Decrypt all tables. The restart without keyring plugin functional should work as there should not be
# any system tables left encrypted with KEYRING
INSTALL PLUGIN keyring_file SONAME 'keyring_file.so';
SET GLOBAL innodb_encryption_threads=0;
SET GLOBAL default_table_encryption=ONLINE_FROM_KEYRING_TO_UNENCRYPTED;
SET GLOBAL innodb_encryption_threads=4;
# Wait max 10 min for key encryption threads to decrypt all spaces (apart from t_keyring)
include/assert.inc [Table t_keyring should stay encrypted]
SET GLOBAL innodb_encryption_threads=0;
UNINSTALL PLUGIN keyring_file;
#It should not be possible to start server with encryption threads > 0 and no keyring installed
# It should not be possible to start server with encryption threads > 0 and keyring not properly
# intialized
# Check that keyring_file was not properly intialized by checking error log
# We should get error in error log as that it is not possible to start encryption threads
# when keyring is not properly initialized.
# Start with keyring plugin installed but not functional (impossible keyring file path). Enabling encryption threads should not be possible as well as creating tables encrypted with KEYRING.
# restart:--early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=/homeless/root/mysecret_keyring KEYRING_PLUGIN_OPT --default-table-encryption=ONLINE_FROM_KEYRING_TO_UNENCRYPTED --innodb-encryption-threads=0 --log-error=MYSQL_TMP_DIR/my_restart.err --default-table-encryption=OFF
SET GLOBAL innodb_encryption_threads=1;
ERROR HY000: InnoDB: cannot enable encryption threads, keyring plugin is not available
CREATE TABLE t1 (a varchar(255)) engine=innodb encryption='KEYRING';
ERROR HY000: Seems that keyring is down. It is not possible to create encrypted tables  without keyring. Please install a keyring and try again.
ALTER TABLE t2 ENCRYPTION='KEYRING';
ERROR HY000: Seems that keyring is down. It is not possible to encrypt table without keyring. Please install a keyring and try again.
ALTER TABLE t_mk ENCRYPTION='KEYRING';
ERROR HY000: Seems that keyring is down. It is not possible to encrypt table without keyring. Please install a keyring and try again.
# restart:--early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=/homeless/root/mysecret_keyring KEYRING_PLUGIN_OPT --default-table-encryption=ONLINE_FROM_KEYRING_TO_UNENCRYPTED --innodb-encryption-threads=0
DROP TABLE t2,t_mk;
CREATE TABLE t1 (a varchar(255)) engine=innodb;
INSERT t1 VALUES (repeat('foobarsecret', 12));
CREATE TABLE t2 (a varchar(255)) engine=innodb;
INSERT t2 VALUES (repeat('foobarsecret', 12));
CREATE TABLE t3 (a varchar(255)) engine=innodb;
INSERT t3 VALUES (repeat('foobarsecret', 12));
CREATE TABLE t4 (a varchar(255)) engine=innodb;
INSERT t4 VALUES (repeat('foobarsecret', 12));
CREATE TABLE t5 (a varchar(255)) engine=innodb;
INSERT t5 VALUES (repeat('foobarsecret', 12));
CREATE TABLE t6 (a varchar(255)) engine=innodb;
INSERT t6 VALUES (repeat('foobarsecret', 12));
SET @@global.keyring_file_data= '/percona/git/8_0_improve_validation_without_asan_bld/mysql-test/var/tmp/mysecret_keyring';
ERROR HY000: Unknown system variable 'keyring_file_data'
ALTER TABLE t_keyring ENCRYPTION='N';
ERROR HY000: Got error 501 'Table encrypted but decryption key was not found. Is correct keyring loaded?' from InnoDB
# restart:--default-table-encryption=ONLINE_FROM_KEYRING_TO_UNENCRYPTED --innodb-encryption-threads=0
DROP TABLE t1,t2,t3,t4,t5,t6,t_keyring;
